# ä¼˜åŒ–åçš„Flinkå®æ—¶è®¡ç®—æ¶æ„è¯´æ˜

## ğŸ¯ æ¶æ„ä¼˜åŒ–æ¦‚è¿°

ç»è¿‡æ·±åº¦ä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„Flinkæ¶æ„ç°åœ¨é‡‡ç”¨**èŒè´£åˆ†ç¦»è®¾è®¡**ï¼Œå®ç°äº†æ›´å¥½çš„æ¨¡å—åŒ–å’Œå¯ç»´æŠ¤æ€§ã€‚

## ğŸ—ï¸ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### ğŸ“‹ èŒè´£åˆ†å·¥
```
CommonWideTableApp (å…¥å£ç±»)
    â†“ åªè´Ÿè´£è·¯ç”±å‘ç°å’Œtypeè½¬å‘
    
EventProcessor (å¤„ç†å™¨)
    â†“ è´Ÿè´£ä¸šåŠ¡é€»è¾‘ + è¾“å‡ºå†³ç­– + æ•°æ®è¾“å‡º
    
UnifiedSinkService (è¾“å‡ºæœåŠ¡)
    â†“ æä¾›ç»Ÿä¸€çš„MySQLå’ŒKafkaè¾“å‡ºå°è£…
```

### ğŸ¯ è®¾è®¡ä¼˜åŠ¿
- âœ… **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªç»„ä»¶èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- âœ… **é«˜åº¦å¤ç”¨**ï¼šæ‰€æœ‰topicä½¿ç”¨åŒä¸€ä¸ªå…¥å£
- âœ… **çµæ´»è¾“å‡º**ï¼šæ¯ä¸ªprocessorè‡ªä¸»å†³å®šè¾“å‡ºç­–ç•¥
- âœ… **é…ç½®ç®€åŒ–**ï¼šåªéœ€é…ç½®topic:type â†’ processorçš„æ˜ å°„

## ğŸ“Š ä¼˜åŒ–åçš„æ¶æ„å›¾

```
Kafkaäº‹ä»¶æº                     MySQLè·¯ç”±é…ç½®           ç»´è¡¨æ•°æ®
(topic-events)                 (ç®€åŒ–é…ç½®è¡¨)           (ç¼“å­˜æŸ¥è¯¢)
      â”‚                            â”‚                     â”‚
      â–¼                            â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                CommonWideTableApp                           â”‚
â”‚                   (ç»Ÿä¸€å…¥å£)                                â”‚
â”‚                                                             â”‚
â”‚  1. è§£æäº‹ä»¶ domain:type (äºŒçº§è·¯ç”±)                          â”‚
â”‚  2. è·¯ç”±é”®åŒ¹é…: wrongbook:wrongbook_add                      â”‚
â”‚  3. è½¬å‘åˆ°å¯¹åº”å¤„ç†å™¨                                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ BusinessEvent
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  EventProcessor                             â”‚
â”‚                (ä¸šåŠ¡å¤„ç†å™¨)                                  â”‚
â”‚                                                             â”‚
â”‚  1. ä¸šåŠ¡é€»è¾‘å¤„ç†                                            â”‚
â”‚  2. ç»´è¡¨æŸ¥è¯¢ (DimTableQueryService)                         â”‚
â”‚  3. è¾“å‡ºå†³ç­– (æ ¹æ®ä¸šåŠ¡è§„åˆ™)                                  â”‚
â”‚  4. æ•°æ®è¾“å‡º (UnifiedSinkService)                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ è‡ªä¸»è¾“å‡º
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                UnifiedSinkService                           â”‚
â”‚                 (ç»Ÿä¸€è¾“å‡ºæœåŠ¡)                               â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   MySQLè¾“å‡º      â”‚              â”‚   Kafkaè¾“å‡º      â”‚       â”‚
â”‚  â”‚ - è¿æ¥æ± ç®¡ç†      â”‚              â”‚ - åºåˆ—åŒ–å°è£…     â”‚       â”‚
â”‚  â”‚ - æ‰¹é‡å†™å…¥       â”‚              â”‚ - è®¤è¯æ”¯æŒ       â”‚       â”‚
â”‚  â”‚ - é”™è¯¯é‡è¯•       â”‚              â”‚ - åˆ†åŒºç­–ç•¥       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. CommonWideTableApp - ç»Ÿä¸€å…¥å£
```java
// è¶…çº§ç®€åŒ–çš„ä½¿ç”¨æ–¹å¼
public static void main(String[] args) throws Exception {
    CommonWideTableApp.execute("wrongbook");
}
```

**èŒè´£**ï¼š
- âœ… è·¯ç”±å‘ç°å’Œäº‹ä»¶è½¬å‘
- âœ… ç¯å¢ƒé…ç½®å’Œä½œä¸šå¯åŠ¨
- âŒ ä¸å†è´Ÿè´£Sinké…ç½®
- âŒ ä¸å†å¤„ç†è¾“å‡ºé€»è¾‘

### 2. EventProcessor - ä¸šåŠ¡å¤„ç†å™¨
```java
@ProcessorConfig(eventTypes = {"wrongbook:wrongbook_add"})
public class WrongbookAddProcessor implements EventProcessor {
    
    @Override
    public void process(BusinessEvent event, Collector<ProcessedEvent> collector) {
        // 1. ä¸šåŠ¡é€»è¾‘å¤„ç†
        // 2. ç»´è¡¨æŸ¥è¯¢
        // 3. è¾“å‡ºå†³ç­–
        // 4. æ•°æ®è¾“å‡º
    }
}
```

**èŒè´£**ï¼š
- âœ… ä¸šåŠ¡é€»è¾‘å¤„ç†
- âœ… ç»´è¡¨æŸ¥è¯¢å’Œæ•°æ®ä¸°å¯Œ
- âœ… è¾“å‡ºç›®æ ‡å†³ç­–
- âœ… æ•°æ®è¾“å‡ºæ‰§è¡Œ

### 3. UnifiedSinkService - ç»Ÿä¸€è¾“å‡ºæœåŠ¡
```java
UnifiedSinkService sinkService = UnifiedSinkService.getInstance();

// MySQLè¾“å‡º
sinkService.createMySQLSink("table_name", sqlBuilder);

// Kafkaè¾“å‡º
sinkService.createKafkaSink("topic_name");
```

**åŠŸèƒ½**ï¼š
- âœ… MySQLå’ŒKafkaè¾“å‡ºå°è£…
- âœ… è¿æ¥æ± å’Œæ€§èƒ½ä¼˜åŒ–
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- âœ… é…ç½®ç®¡ç†å’Œç¼“å­˜

## ğŸ“‹ é…ç½®ç®€åŒ–

### è·¯ç”±é…ç½®è¡¨ (ç®€åŒ–ç‰ˆ)
```sql
CREATE TABLE flink_routing_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    domain VARCHAR(50) NOT NULL COMMENT 'ä¸šåŠ¡åŸŸ',
    event_type VARCHAR(100) NOT NULL COMMENT 'äº‹ä»¶ç±»å‹',
    processor_class VARCHAR(200) NOT NULL COMMENT 'å¤„ç†å™¨ç±»å',
    is_enabled BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    priority INT DEFAULT 100 COMMENT 'ä¼˜å…ˆçº§',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_domain_type (domain, event_type)
);
```

### é…ç½®ç¤ºä¾‹
```sql
-- é”™é¢˜æ·»åŠ äº‹ä»¶ï¼ˆç®€åŒ–é…ç½®ï¼‰
INSERT INTO flink_routing_config (domain, event_type, processor_class) 
VALUES ('wrongbook', 'wrongbook_add', 
        'com.flink.realtime.topics.wrongbook.processor.WrongbookAddProcessor');

-- é”™é¢˜è®¢æ­£äº‹ä»¶
INSERT INTO flink_routing_config (domain, event_type, processor_class)
VALUES ('wrongbook', 'wrongbook_fix',
        'com.flink.realtime.topics.wrongbook.processor.WrongbookFixProcessor');
```

**ç®€åŒ–ç‚¹**ï¼š
- âŒ ä¸å†éœ€è¦å¤æ‚çš„output_configé…ç½®
- âŒ ä¸å†éœ€è¦sinksæ•°ç»„é…ç½®
- âœ… åªéœ€è¦ç®€å•çš„è·¯ç”±æ˜ å°„

## ğŸš€ ä½¿ç”¨æµç¨‹

### 1. æ–°å¢ä¸šåŠ¡Topic
```java
// 1. åˆ›å»ºAppç±»ï¼ˆæç®€ï¼‰
public class UserWideTableApp {
    public static void main(String[] args) throws Exception {
        CommonWideTableApp.execute("user");
    }
}

// 2. å®ç°å¤„ç†å™¨
@ProcessorConfig(eventTypes = {"user:user_register"})
public class UserRegisterProcessor implements EventProcessor {
    // ä¸šåŠ¡é€»è¾‘ + è¾“å‡ºå†³ç­–
}

// 3. é…ç½®è·¯ç”±
INSERT INTO flink_routing_config (domain, event_type, processor_class)
VALUES ('user', 'user_register', 'com.flink.realtime.topics.user.processor.UserRegisterProcessor');
```

### 2. å¤„ç†å™¨å¼€å‘æ¨¡å¼
```java
@ProcessorConfig(eventTypes = {"wrongbook:wrongbook_add"})
public class WrongbookAddProcessor implements EventProcessor {
    
    private final DimTableQueryService dimService = DimTableQueryService.getInstance();
    private final UnifiedSinkService sinkService = UnifiedSinkService.getInstance();
    
    @Override
    public void process(BusinessEvent event, Collector<ProcessedEvent> collector) {
        // 1. è§£æpayload
        WrongbookAddPayload payload = parsePayload(event);
        
        // 2. æŸ¥è¯¢ç»´è¡¨
        enrichWithDimensions(payload);
        
        // 3. æ„å»ºå®½è¡¨æ•°æ®
        Map<String, Object> wideTableData = buildWideTableData(payload);
        
        // 4. å†³å®šè¾“å‡ºç›®æ ‡
        if (shouldOutputToMySQL(payload)) {
            outputToMySQL(wideTableData);
        }
        
        if (shouldOutputToKafka(payload)) {
            outputToKafka(wideTableData);
        }
        
        // 5. æ”¶é›†ç›‘æ§äº‹ä»¶
        collector.collect(new ProcessedEvent(event, wideTableData, null));
    }
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. è¿æ¥æ± ç®¡ç†
- **MySQLè¿æ¥æ± **ï¼šå¤ç”¨æ•°æ®åº“è¿æ¥
- **Kafkaç”Ÿäº§è€…æ± **ï¼šå¤ç”¨Kafkaè¿æ¥
- **ç»´è¡¨æŸ¥è¯¢ç¼“å­˜**ï¼š30åˆ†é’ŸTTLç¼“å­˜

### 2. æ‰¹é‡å¤„ç†
- **MySQLæ‰¹é‡å†™å…¥**ï¼š1000æ¡/æ‰¹æˆ–5ç§’é—´éš”
- **Kafkaæ‰¹é‡å‘é€**ï¼šè‡ªåŠ¨æ‰¹é‡ä¼˜åŒ–
- **ç»´è¡¨æ‰¹é‡æŸ¥è¯¢**ï¼šINæŸ¥è¯¢æ”¯æŒ

### 3. é”™è¯¯å¤„ç†
- **è‡ªåŠ¨é‡è¯•æœºåˆ¶**ï¼š3æ¬¡é‡è¯•
- **æ­»ä¿¡é˜Ÿåˆ—**ï¼šå¤„ç†å¤±è´¥äº‹ä»¶
- **ç›‘æ§æŒ‡æ ‡**ï¼šå®Œæ•´çš„æ€§èƒ½ç›‘æ§

## ğŸ” ç›‘æ§å’Œè¿ç»´

### å…³é”®æŒ‡æ ‡
- **å¤„ç†å™¨æ€§èƒ½**ï¼šå„processorçš„å¤„ç†å»¶è¿Ÿå’Œååé‡
- **è¾“å‡ºæˆåŠŸç‡**ï¼šMySQL/Kafkaè¾“å‡ºæˆåŠŸç‡
- **ç»´è¡¨æŸ¥è¯¢æ€§èƒ½**ï¼šç¼“å­˜å‘½ä¸­ç‡å’ŒæŸ¥è¯¢å»¶è¿Ÿ
- **é”™è¯¯ç‡ç»Ÿè®¡**ï¼šå„ç±»å¼‚å¸¸çš„åˆ†ç±»ç»Ÿè®¡

### è¿ç»´æ“ä½œ
```sql
-- æŸ¥çœ‹å¤„ç†å™¨çŠ¶æ€
SELECT domain, event_type, processor_class, is_enabled 
FROM flink_routing_config 
WHERE domain = 'wrongbook';

-- ç¦ç”¨æŸä¸ªå¤„ç†å™¨
UPDATE flink_routing_config 
SET is_enabled = false 
WHERE domain = 'wrongbook' AND event_type = 'wrongbook_add';

-- æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
-- é€šè¿‡JMXæˆ–æ—¥å¿—æŸ¥çœ‹DimTableQueryServiceç¼“å­˜çŠ¶æ€
```

## ğŸ‰ æ¶æ„ä¼˜åŠ¿æ€»ç»“

### âœ… å¼€å‘æ•ˆç‡æå‡
- **æ–°å¢topic**: åªéœ€1ä¸ªAppç±»ï¼ˆ3è¡Œä»£ç ï¼‰+ Nä¸ªå¤„ç†å™¨
- **é…ç½®ç®€åŒ–**: åªéœ€é…ç½®ç®€å•çš„è·¯ç”±æ˜ å°„
- **ä»£ç å¤ç”¨**: é«˜åº¦å¤ç”¨é€šç”¨ç»„ä»¶

### âœ… è¿ç»´ä¾¿åˆ©æ€§
- **ç»Ÿä¸€å…¥å£**: æ‰€æœ‰ä½œä¸šä½¿ç”¨ç›¸åŒçš„å…¥å£æ¨¡å¼
- **é…ç½®é›†ä¸­**: è·¯ç”±é…ç½®é›†ä¸­ç®¡ç†
- **ç›‘æ§ç»Ÿä¸€**: ç»Ÿä¸€çš„ç›‘æ§å’ŒæŒ‡æ ‡ä½“ç³»

### âœ… æ€§èƒ½ä¼˜åŒ–
- **è¿æ¥å¤ç”¨**: æ•°æ®åº“å’ŒKafkaè¿æ¥æ± 
- **ç¼“å­˜ä¼˜åŒ–**: ç»´è¡¨æŸ¥è¯¢ç¼“å­˜
- **æ‰¹é‡å¤„ç†**: é«˜æ•ˆçš„æ‰¹é‡å†™å…¥

### âœ… æ‰©å±•æ€§ä¿è¯
- **å¤„ç†å™¨ç‹¬ç«‹**: å„processorç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²
- **è¾“å‡ºçµæ´»**: æ¯ä¸ªprocessorè‡ªä¸»å†³å®šè¾“å‡ºç­–ç•¥
- **é…ç½®çƒ­æ›´æ–°**: 30ç§’å†…é…ç½®å˜æ›´ç”Ÿæ•ˆ

**è¿™ä¸ªä¼˜åŒ–åçš„æ¶æ„å®ç°äº†çœŸæ­£çš„æ¨¡å—åŒ–ã€é«˜æ€§èƒ½å’Œæ˜“ç»´æŠ¤ï¼** ğŸš€
