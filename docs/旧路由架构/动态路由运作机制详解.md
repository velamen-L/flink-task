# åŠ¨æ€è·¯ç”±è¿ä½œæœºåˆ¶è¯¦è§£

## ğŸ¯ åŠ¨æ€è·¯ç”±æ¶æ„æ¦‚è¿°

åŠ¨æ€è·¯ç”±æ˜¯æˆ‘ä»¬Flinkå®æ—¶è®¡ç®—æ¶æ„çš„æ ¸å¿ƒç‰¹æ€§ï¼Œæ”¯æŒåœ¨è¿è¡Œæ—¶åŠ¨æ€æ›´æ–°è·¯ç”±é…ç½®ï¼Œæ— éœ€é‡å¯ä½œä¸šå³å¯æ”¯æŒæ–°çš„äº‹ä»¶ç±»å‹å’Œå¤„ç†é€»è¾‘ã€‚

## ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶æ¶æ„

```
                        MySQLé…ç½®è¡¨
                   (flink_routing_config)
                            â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  DynamicRoutingConfigSource  â”‚
              â”‚  - 30ç§’å®šæ—¶è½®è¯¢é…ç½®è¡¨         â”‚
              â”‚  - æ£€æµ‹é…ç½®å˜åŒ–å¹¶å¹¿æ’­         â”‚
              â”‚  - æ”¯æŒå¢é‡æ›´æ–°              â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ å¹¿æ’­æµ
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Kafkaäº‹ä»¶æº  â”‚â”€â†’â”‚ DynamicRoutingProcessFunction â”‚
â”‚ (BusinessEvent)â”‚  â”‚  - æ¥æ”¶é…ç½®å¹¿æ’­æµ            â”‚
â”‚               â”‚  â”‚  - ç»´æŠ¤è·¯ç”±çŠ¶æ€ç¼“å­˜          â”‚
â”‚               â”‚  â”‚  - åŠ¨æ€åˆ›å»ºäº‹ä»¶å¤„ç†å™¨        â”‚
â”‚               â”‚  â”‚  - äºŒçº§è·¯ç”±åŒ¹é…             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚ ProcessedEvent
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ OutputRoutingProcessFunction â”‚
                    â”‚  - å¤šè·¯è¾“å‡ºåˆ†æµ              â”‚
                    â”‚  - MySQL/KafkaåŒè¾“å‡ºæ”¯æŒ     â”‚
                    â”‚  - ä¾§æµå¤„ç†ï¼ˆå‘Šè­¦/æŒ‡æ ‡ï¼‰      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ è·¯ç”±å·¥ä½œæµç¨‹

### 1. é…ç½®ç®¡ç†é˜¶æ®µ

#### é…ç½®è¡¨ç»“æ„
```sql
CREATE TABLE flink_routing_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    domain VARCHAR(50) NOT NULL COMMENT 'ä¸šåŠ¡åŸŸï¼ˆå¦‚wrongbookï¼‰',
    event_type VARCHAR(100) NOT NULL COMMENT 'äº‹ä»¶ç±»å‹ï¼ˆå¦‚wrongbook_addï¼‰',
    processor_class VARCHAR(200) NOT NULL COMMENT 'å¤„ç†å™¨ç±»å',
    output_config JSON COMMENT 'è¾“å‡ºé…ç½®ï¼ˆæ”¯æŒMySQL/KafkaåŒè¾“å‡ºï¼‰',
    is_enabled BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    priority INT DEFAULT 100 COMMENT 'ä¼˜å…ˆçº§',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_domain_type (domain, event_type)
);
```

#### ç¤ºä¾‹é…ç½®æ•°æ®
```sql
-- é”™é¢˜æ·»åŠ äº‹ä»¶é…ç½®ï¼ˆMySQLè¾“å‡ºï¼‰
INSERT INTO flink_routing_config (domain, event_type, processor_class, output_config) 
VALUES ('wrongbook', 'wrongbook_add', 
        'com.flink.realtime.topics.wrongbook.processor.WrongbookAddProcessor',
        '{"sinks": ["mysql", "wide_table"]}');

-- é”™é¢˜è®¢æ­£äº‹ä»¶é…ç½®ï¼ˆåŒè¾“å‡ºï¼šMySQL + Kafkaï¼‰
INSERT INTO flink_routing_config (domain, event_type, processor_class, output_config)
VALUES ('wrongbook', 'wrongbook_fix',
        'com.flink.realtime.topics.wrongbook.processor.WrongbookFixProcessor', 
        '{"sinks": ["mysql", "kafka", "downstream_topic"]}');
```

### 2. é…ç½®å¹¿æ’­é˜¶æ®µ

#### DynamicRoutingConfigSourceå·¥ä½œæœºåˆ¶
```java
// 1. åˆå§‹åŒ–é˜¶æ®µï¼šåŠ è½½æ‰€æœ‰é…ç½®
private void loadAllConfigs(SourceContext<RoutingConfig> ctx) {
    String sql = "SELECT * FROM flink_routing_config WHERE domain = ? ORDER BY priority DESC";
    // æ‰§è¡ŒæŸ¥è¯¢å¹¶å¹¿æ’­æ‰€æœ‰é…ç½®åˆ°ä¸‹æ¸¸
}

// 2. å®šæ—¶æ£€æŸ¥é˜¶æ®µï¼šæ¯30ç§’æ£€æŸ¥æ›´æ–°
private void checkConfigUpdates(SourceContext<RoutingConfig> ctx) {
    String sql = "SELECT * FROM flink_routing_config WHERE domain = ? AND update_time > ?";
    // åªæŸ¥è¯¢æœ‰æ›´æ–°çš„é…ç½®ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“
}
```

#### é…ç½®æ›´æ–°çš„è§¦å‘æœºåˆ¶
- **å®šæ—¶æ£€æŸ¥**ï¼šæ¯30ç§’æŸ¥è¯¢ä¸€æ¬¡é…ç½®è¡¨
- **å¢é‡æ›´æ–°**ï¼šåªä¼ è¾“æœ‰å˜åŒ–çš„é…ç½®é¡¹
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šåŸºäºupdate_timeå­—æ®µåˆ¤æ–­æ˜¯å¦æœ‰æ›´æ–°
- **å¼‚å¸¸æ¢å¤**ï¼šé…ç½®æŸ¥è¯¢å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•

### 3. äº‹ä»¶è·¯ç”±é˜¶æ®µ

#### äºŒçº§è·¯ç”±åŒ¹é…
```java
// è·¯ç”±é”®æ ¼å¼ï¼šdomain:typeï¼ˆäºŒçº§è·¯ç”±ï¼‰
String routingKey = event.getDomain() + ":" + event.getType();
// ä¾‹å¦‚ï¼šwrongbook:wrongbook_add
```

#### è·¯ç”±å†³ç­–æµç¨‹
```java
// 1. ä»å¹¿æ’­çŠ¶æ€è·å–è·¯ç”±é…ç½®
RoutingConfig config = configState.get(routingKey);

// 2. æ£€æŸ¥é…ç½®æœ‰æ•ˆæ€§
if (config == null || !config.isEnabled()) {
    // è®°å½•å¤±è´¥æŒ‡æ ‡ï¼Œäº‹ä»¶è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
    return;
}

// 3. è·å–æˆ–åˆ›å»ºå¤„ç†å™¨
EventProcessor processor = getOrCreateProcessor(config.getProcessorClass());

// 4. æ‰§è¡Œä¸šåŠ¡å¤„ç†
Object result = processor.process(event);

// 5. æ„é€ è¾“å‡ºäº‹ä»¶
ProcessedEvent processedEvent = new ProcessedEvent(event, result, config.getOutputConfig());
```

### 4. å¤„ç†å™¨ç®¡ç†é˜¶æ®µ

#### å¤„ç†å™¨åˆ›å»ºå’Œç¼“å­˜
```java
private final Map<String, EventProcessor> processorCache = new ConcurrentHashMap<>();

private EventProcessor getOrCreateProcessor(String processorClass) {
    return processorCache.computeIfAbsent(processorClass, className -> {
        try {
            // åŠ¨æ€åŠ è½½å¤„ç†å™¨ç±»
            Class<?> clazz = Class.forName(className);
            EventProcessor processor = (EventProcessor) clazz.newInstance();
            logger.info("åˆ›å»ºæ–°å¤„ç†å™¨å®ä¾‹: {}", className);
            return processor;
        } catch (Exception e) {
            logger.error("åˆ›å»ºå¤„ç†å™¨å¤±è´¥: {}", className, e);
            return null;
        }
    });
}
```

#### å¤„ç†å™¨çƒ­æ›´æ–°æœºåˆ¶
- **é…ç½®æ›´æ–°æ—¶æ¸…ç†ç¼“å­˜**ï¼šç¡®ä¿ä½¿ç”¨æœ€æ–°çš„å¤„ç†å™¨
- **ç±»åŠ è½½éš”ç¦»**ï¼šæ”¯æŒå¤„ç†å™¨ç‰ˆæœ¬å‡çº§
- **å¼‚å¸¸éš”ç¦»**ï¼šå•ä¸ªå¤„ç†å™¨å¼‚å¸¸ä¸å½±å“å…¶ä»–å¤„ç†å™¨

### 5. è¾“å‡ºè·¯ç”±é˜¶æ®µ

#### å¤šè¾“å‡ºç›®æ ‡æ”¯æŒ
```java
// æ ¹æ®è¾“å‡ºé…ç½®å†³å®šæ•°æ®å»å‘
if (config.getOutputConfig() != null) {
    Object sinks = config.getOutputConfig().get("sinks");
    if (sinks instanceof List) {
        processedEvent.setOutputTargets((List<String>) sinks);
    }
}
```

#### è¾“å‡ºç›®æ ‡ç±»å‹
- **mysql/wide_table**: å†™å…¥MySQLå®½è¡¨
- **kafka/downstream_topic**: å†™å…¥Kafkaä¸‹æ¸¸topic
- **alert_topic**: å†™å…¥å‘Šè­¦æµ
- **metrics_topic**: å†™å…¥æŒ‡æ ‡æµ
- **audit_topic**: å†™å…¥å®¡è®¡æµ

## ğŸ›ï¸ é…ç½®ç®¡ç†æ“ä½œ

### è¿è¡Œæ—¶é…ç½®ç®¡ç†
```bash
# æŸ¥çœ‹å½“å‰è·¯ç”±é…ç½®
java -cp flink-job.jar com.flink.realtime.config.RoutingConfigManager list wrongbook

# æ·»åŠ æ–°çš„è·¯ç”±é…ç½®
java -cp flink-job.jar com.flink.realtime.config.RoutingConfigManager add \
  wrongbook wrongbook_delete \
  com.flink.realtime.topics.wrongbook.processor.WrongbookDeleteProcessor

# å¯ç”¨/ç¦ç”¨è·¯ç”±é…ç½®
java -cp flink-job.jar com.flink.realtime.config.RoutingConfigManager enable wrongbook wrongbook_add
java -cp flink-job.jar com.flink.realtime.config.RoutingConfigManager disable wrongbook wrongbook_add

# åˆ é™¤è·¯ç”±é…ç½®
java -cp flink-job.jar com.flink.realtime.config.RoutingConfigManager delete wrongbook wrongbook_add
```

### SQLæ–¹å¼é…ç½®ç®¡ç†
```sql
-- æ–°å¢è·¯ç”±é…ç½®
INSERT INTO flink_routing_config (domain, event_type, processor_class, output_config, is_enabled)
VALUES ('wrongbook', 'wrongbook_batch_import', 
        'com.flink.realtime.topics.wrongbook.processor.WrongbookBatchImportProcessor',
        '{"sinks": ["mysql", "kafka"]}', true);

-- ä¿®æ”¹è¾“å‡ºé…ç½®ï¼ˆæ”¯æŒåŒè¾“å‡ºï¼‰
UPDATE flink_routing_config 
SET output_config = '{"sinks": ["mysql", "kafka", "downstream_topic"]}',
    update_time = CURRENT_TIMESTAMP
WHERE domain = 'wrongbook' AND event_type = 'wrongbook_add';

-- ç¦ç”¨æŸä¸ªè·¯ç”±
UPDATE flink_routing_config 
SET is_enabled = false, 
    update_time = CURRENT_TIMESTAMP
WHERE domain = 'wrongbook' AND event_type = 'wrongbook_delete';
```

## ğŸ“Š ç›‘æ§å’Œè¿ç»´

### å…³é”®æŒ‡æ ‡ç›‘æ§
- **é…ç½®åŠ è½½æˆåŠŸç‡**: é…ç½®æ›´æ–°çš„æˆåŠŸæ¯”ä¾‹
- **è·¯ç”±åŒ¹é…ç‡**: äº‹ä»¶æˆåŠŸè·¯ç”±çš„æ¯”ä¾‹
- **å¤„ç†å™¨ç¼“å­˜å‘½ä¸­ç‡**: å¤„ç†å™¨ç¼“å­˜çš„æ•ˆç‡
- **å¤„ç†å»¶è¿Ÿ**: ç«¯åˆ°ç«¯çš„å¤„ç†å»¶è¿Ÿ
- **å¼‚å¸¸ç‡**: å¤„ç†å¤±è´¥çš„äº‹ä»¶æ¯”ä¾‹

### æ•…éšœæ’æŸ¥
```java
// 1. æ£€æŸ¥è·¯ç”±é…ç½®æ˜¯å¦å­˜åœ¨
SELECT * FROM flink_routing_config WHERE domain = 'wrongbook' AND event_type = 'wrongbook_add';

// 2. æ£€æŸ¥å¤„ç†å™¨ç±»æ˜¯å¦å¯åŠ è½½
try {
    Class<?> clazz = Class.forName("com.flink.realtime.topics.wrongbook.processor.WrongbookAddProcessor");
    EventProcessor processor = (EventProcessor) clazz.newInstance();
} catch (Exception e) {
    // å¤„ç†å™¨ç±»åŠ è½½å¤±è´¥
}

// 3. æ£€æŸ¥äº‹ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®
{
  "domain": "wrongbook",
  "type": "wrongbook_add", 
  "eventId": "uuid",
  "timestamp": 1640995200000,
  "payload": { /* ä¸šåŠ¡æ•°æ® */ }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### é…ç½®æŸ¥è¯¢ä¼˜åŒ–
- **å¢é‡æŸ¥è¯¢**: åªæŸ¥è¯¢æœ‰æ›´æ–°çš„é…ç½®
- **è¿æ¥æ± **: ä½¿ç”¨è¿æ¥æ± ç®¡ç†æ•°æ®åº“è¿æ¥
- **ç¼“å­˜ç­–ç•¥**: æœ¬åœ°ç¼“å­˜é…ç½®å‡å°‘æ•°æ®åº“æŸ¥è¯¢

### å¤„ç†å™¨ç®¡ç†ä¼˜åŒ–
- **å»¶è¿ŸåŠ è½½**: åªåœ¨éœ€è¦æ—¶åˆ›å»ºå¤„ç†å™¨å®ä¾‹
- **ç¼“å­˜ç­–ç•¥**: åˆç†è®¾ç½®å¤„ç†å™¨ç¼“å­˜å¤§å°
- **å†…å­˜ç®¡ç†**: åŠæ—¶æ¸…ç†æ— ç”¨çš„å¤„ç†å™¨å®ä¾‹

### è·¯ç”±æ€§èƒ½ä¼˜åŒ–
- **å“ˆå¸ŒæŸ¥æ‰¾**: ä½¿ç”¨HashMapå®ç°O(1)è·¯ç”±æŸ¥æ‰¾
- **æ‰¹é‡å¤„ç†**: æ”¯æŒæ‰¹é‡äº‹ä»¶å¤„ç†
- **å¼‚æ­¥å¤„ç†**: ç»´è¡¨æŸ¥è¯¢ä½¿ç”¨å¼‚æ­¥è°ƒç”¨

## ğŸ”§ æ‰©å±•æ€§è®¾è®¡

### æ”¯æŒæ–°ä¸šåŠ¡åŸŸ
1. åœ¨é…ç½®è¡¨ä¸­æ·»åŠ æ–°çš„domain
2. åˆ›å»ºå¯¹åº”çš„å¤„ç†å™¨ç±»
3. é…ç½®è·¯ç”±è§„åˆ™
4. æ— éœ€é‡å¯ä½œä¸š

### æ”¯æŒæ–°äº‹ä»¶ç±»å‹
1. åœ¨ç°æœ‰domainä¸‹æ·»åŠ æ–°çš„event_type
2. å®ç°å¯¹åº”çš„EventProcessor
3. æ›´æ–°è·¯ç”±é…ç½®
4. 30ç§’å†…è‡ªåŠ¨ç”Ÿæ•ˆ

### æ”¯æŒæ–°è¾“å‡ºç›®æ ‡
1. æ‰©å±•output_configé…ç½®
2. åœ¨OutputRoutingProcessFunctionä¸­æ·»åŠ æ–°çš„è¾“å‡ºé€»è¾‘
3. é…ç½®å¯¹åº”çš„Sink
4. æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´

---

**åŠ¨æ€è·¯ç”±æœºåˆ¶çš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼šé›¶åœæœºæ—¶é—´çš„é…ç½®æ›´æ–°ã€å¿«é€Ÿå“åº”ä¸šåŠ¡å˜åŒ–ã€ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†æ¡†æ¶ï¼** ğŸ‰
