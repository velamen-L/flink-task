# Flink å®æ—¶å¼€å‘è§„èŒƒæ–‡æ¡£

## ğŸ“– æ¦‚è¿°

æœ¬è§„èŒƒåŸºäºäº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEvent-Driven Architectureï¼‰ï¼Œå®šä¹‰äº†ä¼ä¸šçº§ Flink å®æ—¶æ•°æ®å¤„ç†çš„æ ‡å‡†åŒ–å¼€å‘è§„èŒƒã€‚é€šè¿‡ç»Ÿä¸€çš„äº‹ä»¶æ¨¡å‹ã€æ•°æ®ç»“æ„å’Œå¼€å‘æµç¨‹ï¼Œç¡®ä¿ Flink ä½œä¸šçš„é«˜è´¨é‡ã€é«˜æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚

---

## ğŸ¯ Flink ä½¿ç”¨åœºæ™¯

### 1.1 æ ¸å¿ƒä¸šåŠ¡åœºæ™¯

#### ğŸ—ï¸ å®½è¡¨æ‰“å®½ï¼ˆWide Table Constructionï¼‰
**ä¸šåŠ¡ç›®æ ‡**ï¼šå°†å¤šä¸ªäº‹ä»¶æºçš„æ•°æ®å…³è”ç»„æˆå®Œæ•´çš„ä¸šåŠ¡æ•°æ®è§†å›¾

**å…¸å‹åœºæ™¯**ï¼š
- **é”™é¢˜æœ¬å®½è¡¨**ï¼šå…³è”é”™é¢˜æ”¶é›†äº‹ä»¶ã€ä¿®æ­£äº‹ä»¶ã€çŸ¥è¯†ç‚¹ä¿¡æ¯ï¼Œå½¢æˆå®Œæ•´çš„å­¦ä¹ è½¨è¿¹
- **è®¢å•å®½è¡¨**ï¼šå…³è”ä¸‹å•ã€æ”¯ä»˜ã€ç‰©æµã€è¯„ä»·ç­‰äº‹ä»¶ï¼Œæ„å»ºå®Œæ•´è®¢å•ç”Ÿå‘½å‘¨æœŸ
- **ç”¨æˆ·è¡Œä¸ºå®½è¡¨**ï¼šæ•´åˆç™»å½•ã€æµè§ˆã€è´­ä¹°ç­‰è¡Œä¸ºæ•°æ®ï¼Œæ”¯æ’‘ç”¨æˆ·ç”»åƒæ„å»º

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- äº‹ä»¶æ—¶é—´è¯­ä¹‰ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
- å¤šç»´è¡¨ LEFT JOINï¼Œä¸°å¯Œäº‹ä»¶ä¸Šä¸‹æ–‡
- æ”¯æŒäº‹ä»¶ä¹±åºå’Œå»¶è¿Ÿåˆ°è¾¾å¤„ç†

**æ¶æ„æ¨¡å¼**ï¼š
```mermaid
graph LR
    A[ä¸»äº‹ä»¶æµ] --> B[ç»´è¡¨å…³è”]
    B --> C[å­—æ®µæ˜ å°„]
    C --> D[å®½è¡¨è¾“å‡º]
    
    E[ç»´è¡¨1] --> B
    F[ç»´è¡¨2] --> B
    G[ç»´è¡¨3] --> B
```

#### ğŸ“Š æ±‡æ€»ç»Ÿè®¡ï¼ˆAggregation Analyticsï¼‰
**ä¸šåŠ¡ç›®æ ‡**ï¼šå¯¹äº‹ä»¶æµè¿›è¡Œå®æ—¶èšåˆè®¡ç®—ï¼Œäº§å‡ºç»Ÿè®¡æŒ‡æ ‡

**å…¸å‹åœºæ™¯**ï¼š
- **ç”¨æˆ·æ—¥ç»Ÿè®¡**ï¼šç»Ÿè®¡ç”¨æˆ·æ¯æ—¥ç­”é¢˜æ•°ã€æ­£ç¡®ç‡ã€å­¦ä¹ æ—¶é•¿ç­‰æŒ‡æ ‡
- **è¯¾ç¨‹çƒ­åº¦ç»Ÿè®¡**ï¼šå®æ—¶è®¡ç®—è¯¾ç¨‹çš„å­¦ä¹ äººæ•°ã€å®Œæˆç‡ã€è¯„åˆ†ç­‰
- **ç³»ç»Ÿç›‘æ§ç»Ÿè®¡**ï¼šç»Ÿè®¡è¯·æ±‚é‡ã€é”™è¯¯ç‡ã€å“åº”æ—¶é—´ç­‰æŠ€æœ¯æŒ‡æ ‡

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- çª—å£èšåˆï¼ˆæ»šåŠ¨ã€æ»‘åŠ¨ã€ä¼šè¯çª—å£ï¼‰
- å¤šç»´åˆ†ç»„ç»Ÿè®¡
- æ”¯æŒè¿Ÿåˆ°æ•°æ®å¤„ç†å’Œç»“æœæ›´æ–°

**æ¶æ„æ¨¡å¼**ï¼š
```mermaid
graph LR
    A[äº‹ä»¶æµ] --> B[çª—å£åˆ†ç»„]
    B --> C[èšåˆè®¡ç®—]
    C --> D[ç»“æœè¾“å‡º]
    
    E[æ—¶é—´çª—å£] --> B
    F[åˆ†ç»„é”®] --> B
```

#### ğŸ” å®æ—¶åˆ†æï¼ˆReal-time Analysisï¼‰
**ä¸šåŠ¡ç›®æ ‡**ï¼šåŸºäºå®æ—¶æ•°æ®æµè¿›è¡Œå¤æ‚ä¸šåŠ¡é€»è¾‘åˆ†æå’Œå†³ç­–

**å…¸å‹åœºæ™¯**ï¼š
- **å­¦ä¹ è·¯å¾„æ¨è**ï¼šåŸºäºå­¦ä¹ è¡Œä¸ºå®æ—¶è°ƒæ•´ä¸ªæ€§åŒ–å­¦ä¹ è·¯å¾„
- **å¼‚å¸¸æ£€æµ‹**ï¼šå®æ—¶è¯†åˆ«å¼‚å¸¸å­¦ä¹ è¡Œä¸ºæˆ–ç³»ç»Ÿå¼‚å¸¸
- **æ™ºèƒ½é¢„è­¦**ï¼šåŸºäºå¤šæŒ‡æ ‡ç»¼åˆåˆ†æè§¦å‘ä¸šåŠ¡é¢„è­¦

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆCEPï¼‰
- å¤šæµå…³è”å’ŒçŠ¶æ€ç®¡ç†
- å®æ—¶æœºå™¨å­¦ä¹ æ¨¡å‹åº”ç”¨

**æ¶æ„æ¨¡å¼**ï¼š
```mermaid
graph TB
    A[å¤šäº‹ä»¶æµ] --> B[äº‹ä»¶æ¨¡å¼åŒ¹é…]
    C[å†å²çŠ¶æ€] --> B
    B --> D[è§„åˆ™å¼•æ“]
    D --> E[åˆ†æç»“æœ]
    E --> F[å†³ç­–è¾“å‡º]
```

### 1.2 åœºæ™¯é€‰æ‹©åŸåˆ™

| åœºæ™¯ç±»å‹ | æ•°æ®ç‰¹å¾ | è®¡ç®—å¤æ‚åº¦ | å®æ—¶æ€§è¦æ±‚ | é€‚ç”¨ä¸šåŠ¡ |
|----------|----------|------------|------------|----------|
| **å®½è¡¨æ‰“å®½** | å¤šæºå…³è”ï¼Œç»“æ„åŒ– | ä¸­ç­‰ | åˆ†é’Ÿçº§ | æ•°æ®ä»“åº“ã€æŠ¥è¡¨åˆ†æ |
| **æ±‡æ€»ç»Ÿè®¡** | å•ä¸€æˆ–å°‘é‡æºï¼ŒæŒ‡æ ‡è®¡ç®— | ç®€å• | ç§’çº§ | å®æ—¶ç›‘æ§ã€è¿è¥çœ‹æ¿ |
| **å®æ—¶åˆ†æ** | å¤šæºå…³è”ï¼Œå¤æ‚é€»è¾‘ | é«˜ | æ¯«ç§’çº§ | æ™ºèƒ½æ¨èã€é£æ§å†³ç­– |

---

## ğŸ—ï¸ äº‹ä»¶é©±åŠ¨æ¶æ„æ¨¡å‹

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           äº‹ä»¶æºå±‚ (Event Source Layer)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     é”™é¢˜æœ¬äº‹ä»¶       â”‚      ç­”é¢˜äº‹ä»¶       â”‚         ç”¨æˆ·äº‹ä»¶                â”‚
â”‚   wrongbook_fix     â”‚   answer_submit     â”‚      user_login                 â”‚
â”‚   wrongbook_collect â”‚   answer_complete   â”‚      user_profile               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚                     â”‚
          â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          äº‹ä»¶æ€»çº¿å±‚ (Event Bus Layer)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  biz_statistic_     â”‚  biz_statistic_     â”‚    biz_statistic_               â”‚
â”‚     wrongbook       â”‚      answer         â”‚        user                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚                     â”‚
          â”‚                     â”‚                     â”‚
          â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ä½œä¸šå±‚ (Job Layer)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     é”™é¢˜æœ¬ä½œä¸š       â”‚   ç”¨æˆ·æ—¥ç»Ÿè®¡ä½œä¸š     â”‚       å­¦ä¹ åˆ†æä½œä¸š               â”‚
â”‚   WrongbookJob      â”‚ UserDailyStatsJob   â”‚   LearningAnalysisJob           â”‚
â”‚  æ¶ˆè´¹: wrongbook_*  â”‚æ¶ˆè´¹: wrongbook_fix  â”‚  æ¶ˆè´¹: wrongbook_* +            â”‚
â”‚                     â”‚  + answer_submit    â”‚       answer_*                  â”‚
â”‚                     â”‚  + user_login       â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚                     â”‚
          â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ•°æ®è¾“å‡ºå±‚ (Output Layer)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     é”™é¢˜æœ¬å®½è¡¨       â”‚    ç”¨æˆ·æ—¥ç»Ÿè®¡è¡¨      â”‚       å­¦ä¹ åˆ†æè¡¨                â”‚
â”‚                     â”‚                     â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æµå‘è¯´æ˜**ï¼š
- **äº‹ä»¶æºå±‚** â†’ **äº‹ä»¶æ€»çº¿å±‚**ï¼šä¸šåŠ¡äº‹ä»¶é€šè¿‡Kafkaå‘å¸ƒåˆ°å¯¹åº”Topic
- **äº‹ä»¶æ€»çº¿å±‚** â†’ **ä½œä¸šå±‚**ï¼šFlinkä½œä¸šæ¶ˆè´¹äº‹ä»¶è¿›è¡Œå®æ—¶å¤„ç†
- **ä½œä¸šå±‚** â†’ **æ•°æ®è¾“å‡ºå±‚**ï¼šå¤„ç†ç»“æœå†™å…¥ç›®æ ‡å­˜å‚¨ç³»ç»Ÿ

### 2.2 æ¶æ„åˆ†å±‚è¯´æ˜

#### äº‹ä»¶æºå±‚ (Event Source Layer)
- **èŒè´£**ï¼šäº§ç”Ÿå’Œå‘å¸ƒä¸šåŠ¡äº‹ä»¶
- **ç‰¹ç‚¹**ï¼šæŒ‰ä¸šåŠ¡åŸŸåˆ†ç±»ï¼Œäº‹ä»¶ç±»å‹ç»†åˆ†
- **ç¤ºä¾‹**ï¼šç”¨æˆ·æ“ä½œã€ç³»ç»ŸçŠ¶æ€å˜æ›´ã€å¤–éƒ¨æ¥å£è°ƒç”¨

#### äº‹ä»¶æ€»çº¿å±‚ (Event Bus Layer)
- **èŒè´£**ï¼šäº‹ä»¶ä¼ è¾“å’Œåˆ†å‘
- **ç‰¹ç‚¹**ï¼šæŒ‰åŸŸåˆ†Topicï¼Œä¿è¯äº‹ä»¶æœ‰åºæ€§
- **æŠ€æœ¯**ï¼šKafkaã€Pulsarç­‰æ¶ˆæ¯ä¸­é—´ä»¶

#### ä½œä¸šå±‚ (Job Layer)
- **èŒè´£**ï¼šäº‹ä»¶æ¶ˆè´¹å’Œä¸šåŠ¡é€»è¾‘å¤„ç†
- **ç‰¹ç‚¹**ï¼šä¸šåŠ¡é©±åŠ¨ï¼Œæ”¯æŒå¤šæºæ¶ˆè´¹
- **æŠ€æœ¯**ï¼šFlink DataStream APIã€Flink SQL

#### æ•°æ®è¾“å‡ºå±‚ (Output Layer)
- **èŒè´£**ï¼šå¤„ç†ç»“æœå­˜å‚¨å’Œåˆ†å‘
- **ç‰¹ç‚¹**ï¼šæ”¯æŒå¤šç§å­˜å‚¨å¼•æ“
- **æŠ€æœ¯**ï¼šMySQLã€ClickHouseã€Elasticsearchç­‰

---

## ğŸ“‹ æºè¡¨ç»“æ„è§„èŒƒ

### 3.1 ç»Ÿä¸€äº‹ä»¶æ¨¡å‹ï¼šBusinessEvent

#### 3.1.1 æ ‡å‡†äº‹ä»¶ç»“æ„
```java
/**
 * ä¸šåŠ¡äº‹ä»¶ç»Ÿä¸€æ•°æ®æ¨¡å‹
 * æ‰€æœ‰ä¸šåŠ¡äº‹ä»¶å¿…é¡»éµå¾ªæ­¤ç»“æ„
 */
public class BusinessEvent {
    
    // ============ äº‹ä»¶æ ‡è¯† ============
    private String eventId;          // äº‹ä»¶å”¯ä¸€IDï¼ŒUUIDæ ¼å¼
    private String domain;           // ä¸šåŠ¡åŸŸï¼šwrongbookã€answerã€userç­‰
    private String type;             // äº‹ä»¶ç±»å‹ï¼šwrongbook_fixã€answer_submitç­‰
    private String version;          // äº‹ä»¶ç‰ˆæœ¬ï¼šv1.0ã€v2.0ç­‰
    
    // ============ æ—¶é—´ä¿¡æ¯ ============
    private Long eventTime;          // äº‹ä»¶å‘ç”Ÿæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
    private Long processTime;        // äº‹ä»¶å¤„ç†æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
    private String eventDate;        // äº‹ä»¶å‘ç”Ÿæ—¥æœŸï¼ˆyyyy-MM-ddï¼‰
    
    // ============ ç”¨æˆ·ä¿¡æ¯ ============
    private String userId;           // ç”¨æˆ·ID
    private String sessionId;       // ä¼šè¯ID
    private String deviceId;         // è®¾å¤‡ID
    
    // ============ ä¸šåŠ¡è½½è· ============
    private String payload;          // ä¸šåŠ¡æ•°æ®JSONå­—ç¬¦ä¸²
    
    // ============ å…ƒæ•°æ®ä¿¡æ¯ ============
    private String source;           // äº‹ä»¶æºç³»ç»Ÿ
    private String traceId;          // é“¾è·¯è¿½è¸ªID
    private Map<String, String> tags; // æ‰©å±•æ ‡ç­¾
}
```

#### 3.1.2 äº‹ä»¶å‘½åè§„èŒƒ

**Topicå‘½åè§„èŒƒ**ï¼š
```
biz_statistic_{domain}
```

**Typeå‘½åè§„èŒƒ**ï¼š
```
{domain}_{action}
```

**ç¤ºä¾‹**ï¼š
| ä¸šåŠ¡åŸŸ | Topic | Type | è¯´æ˜ |
|--------|-------|------|------|
| é”™é¢˜æœ¬ | `biz_statistic_wrongbook` | `wrongbook_fix` | é”™é¢˜ä¿®æ­£äº‹ä»¶ |
| é”™é¢˜æœ¬ | `biz_statistic_wrongbook` | `wrongbook_collect` | é”™é¢˜æ”¶é›†äº‹ä»¶ |
| ç­”é¢˜ | `biz_statistic_answer` | `answer_submit` | ç­”é¢˜æäº¤äº‹ä»¶ |
| ç­”é¢˜ | `biz_statistic_answer` | `answer_complete` | ç­”é¢˜å®Œæˆäº‹ä»¶ |
| ç”¨æˆ· | `biz_statistic_user` | `user_login` | ç”¨æˆ·ç™»å½•äº‹ä»¶ |

### 3.2 Payload æ•°æ®è§„èŒƒ

#### 3.2.1 Payload è®¾è®¡åŸåˆ™
1. **ç±»å‹ä¸€è‡´æ€§**ï¼šåŒä¸€ `domain + type` ä¸‹çš„ payload ç»“æ„å¿…é¡»ä¸€è‡´
2. **ç‰ˆæœ¬å…¼å®¹æ€§**ï¼šæ–°ç‰ˆæœ¬ payload å¿…é¡»å‘åå…¼å®¹
3. **å­—æ®µå®Œæ•´æ€§**ï¼šåŒ…å«ä¸šåŠ¡å¤„ç†æ‰€éœ€çš„å®Œæ•´ä¿¡æ¯
4. **æ•°æ®ç±»å‹æ ‡å‡†**ï¼šç»Ÿä¸€ä½¿ç”¨æ ‡å‡†æ•°æ®ç±»å‹

#### 3.2.2 Payload ç¤ºä¾‹

**é”™é¢˜ä¿®æ­£äº‹ä»¶ Payload**ï¼š
```java
/**
 * é”™é¢˜ä¿®æ­£äº‹ä»¶è½½è·
 * domain: wrongbook, type: wrongbook_fix
 */
public class WrongbookFixPayload {
    private String fixId;                    // ä¿®æ­£è®°å½•ID
    private String wrongId;                  // åŸé”™é¢˜è®°å½•ID
    private String userId;                   // ç”¨æˆ·ID
    private String questionId;               // é¢˜ç›®ID
    private String subject;                  // å­¦ç§‘
    private String patternId;                // çŸ¥è¯†ç‚¹ID
    private Integer fixResult;               // ä¿®æ­£ç»“æœï¼š0-æœªä¿®æ­£ï¼Œ1-å·²ä¿®æ­£
    private Long submitTime;                 // æäº¤æ—¶é—´
    private String answerContent;            // ä¿®æ­£ç­”æ¡ˆå†…å®¹
    private List<String> attachments;        // é™„ä»¶åˆ—è¡¨
}
```

**ç­”é¢˜æäº¤äº‹ä»¶ Payload**ï¼š
```java
/**
 * ç­”é¢˜æäº¤äº‹ä»¶è½½è·
 * domain: answer, type: answer_submit
 */
public class AnswerSubmitPayload {
    private String answerId;                 // ç­”é¢˜è®°å½•ID
    private String userId;                   // ç”¨æˆ·ID
    private String questionId;               // é¢˜ç›®ID
    private String subject;                  // å­¦ç§‘
    private Integer isCorrect;               // æ˜¯å¦æ­£ç¡®ï¼š0-é”™è¯¯ï¼Œ1-æ­£ç¡®
    private Long answerTime;                 // ç­”é¢˜æ—¶é•¿ï¼ˆç§’ï¼‰
    private Long submitTime;                 // æäº¤æ—¶é—´
    private String userAnswer;               // ç”¨æˆ·ç­”æ¡ˆ
    private String correctAnswer;            // æ­£ç¡®ç­”æ¡ˆ
}
```

### 3.3 å¤šæºè¡¨å…³è”è§„èŒƒ

#### 3.3.1 å¤šæºè¡¨å…³è”é™åˆ¶
```yaml
multi_source_rules:
  max_source_tables: 3                      # æœ€å¤š3ä¸ªæºè¡¨å…³è”
  watermark_skew_max: "5 minutes"           # æ°´ä½çº¿åå·®ä¸è¶…è¿‡5åˆ†é’Ÿ
  state_ttl_max: "24 hours"                 # çŠ¶æ€TTLä¸è¶…è¿‡24å°æ—¶
  join_timeout_max: "10 minutes"            # JOINè¶…æ—¶æ—¶é—´ä¸è¶…è¿‡10åˆ†é’Ÿ
```

#### 3.3.2 æ°´ä½çº¿åŒæ­¥ç­–ç•¥
```sql
-- å¤šæºè¡¨æ°´ä½çº¿é…ç½®ç¤ºä¾‹
CREATE TABLE source_table_1 (
    -- å­—æ®µå®šä¹‰
    event_time AS TO_TIMESTAMP_LTZ(event_timestamp, 0),
    WATERMARK FOR event_time AS event_time - INTERVAL '5' SECOND
);

CREATE TABLE source_table_2 (
    -- å­—æ®µå®šä¹‰  
    event_time AS TO_TIMESTAMP_LTZ(event_timestamp, 0),
    WATERMARK FOR event_time AS event_time - INTERVAL '5' SECOND  -- ä¿æŒä¸€è‡´
);

-- å¤šæµå…³è”ç¤ºä¾‹
SELECT *
FROM source_table_1 s1
JOIN source_table_2 s2
ON s1.join_key = s2.join_key
AND s1.event_time BETWEEN s2.event_time - INTERVAL '1' MINUTE 
                       AND s2.event_time + INTERVAL '1' MINUTE;
```

#### 3.3.3 çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ
```java
// Flink çŠ¶æ€TTLé…ç½®
StateTtlConfig ttlConfig = StateTtlConfig
    .newBuilder(Time.hours(24))              // 24å°æ—¶TTL
    .setUpdateType(StateTtlConfig.UpdateType.OnCreateAndWrite)
    .setStateVisibility(StateTtlConfig.StateVisibility.NeverReturnExpired)
    .cleanupFullSnapshot()                   // å…¨é‡å¿«ç…§æ¸…ç†
    .build();

mapStateDescriptor.enableTimeToLive(ttlConfig);
```

---

## ğŸ”— ç»´è¡¨å…³è”è§„èŒƒ

### 4.1 ç»´è¡¨è®¾è®¡åŸåˆ™

#### 4.1.1 ç»´è¡¨åˆ†ç±»æ ‡å‡†
| ç»´è¡¨ç±»å‹ | æ›´æ–°é¢‘ç‡ | ç¼“å­˜ç­–ç•¥ | é€‚ç”¨åœºæ™¯ |
|----------|----------|----------|----------|
| **é™æ€ç»´è¡¨** | å¾ˆå°‘æ›´æ–° | é•¿æœŸç¼“å­˜(1å¤©+) | åœ°åŒºã€å­¦ç§‘ç­‰åŸºç¡€æ•°æ® |
| **å‡†é™æ€ç»´è¡¨** | å°æ—¶çº§æ›´æ–° | ä¸­æœŸç¼“å­˜(1-6å°æ—¶) | ç”¨æˆ·ä¿¡æ¯ã€è¯¾ç¨‹ä¿¡æ¯ |
| **åŠ¨æ€ç»´è¡¨** | åˆ†é’Ÿçº§æ›´æ–° | çŸ­æœŸç¼“å­˜(5-30åˆ†é’Ÿ) | å®æ—¶çŠ¶æ€ã€ä¸´æ—¶é…ç½® |

#### 4.1.2 ç»´è¡¨è®¿é—®æ¨¡å¼
```sql
-- æ ‡å‡†ç»´è¡¨å…³è”è¯­æ³•
LEFT JOIN dimension_table FOR SYSTEM_TIME AS OF PROCTIME() AS dt
ON source.join_key = dt.primary_key
WHERE dt.is_deleted = false  -- æ ‡å‡†åˆ é™¤æ ‡è¯†è¿‡æ»¤
```

### 4.2 MySQLç»´è¡¨ä¼˜åŒ–è§„èŒƒ

#### 4.2.1 ç´¢å¼•è®¾è®¡è¦æ±‚
```sql
-- ä¸»é”®ç´¢å¼•ï¼ˆå¿…é¡»ï¼‰
PRIMARY KEY (id)

-- å…³è”å­—æ®µç´¢å¼•ï¼ˆå¿…é¡»ï¼‰
INDEX idx_join_key (join_field)

-- å¤åˆç´¢å¼•ï¼ˆæ¨èï¼‰
INDEX idx_composite (join_field, status, is_deleted)

-- æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•ï¼ˆå¯é€‰ï¼‰
INDEX idx_query_optimize (common_filter_field, update_time)
```

#### 4.2.2 ç»´è¡¨ç»“æ„è§„èŒƒ
```sql
-- æ ‡å‡†ç»´è¡¨ç»“æ„æ¨¡æ¿
CREATE TABLE dim_table_template (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,           -- ä¸»é”®ID
    business_key VARCHAR(64) NOT NULL,              -- ä¸šåŠ¡é”®
    
    -- ä¸šåŠ¡å­—æ®µ
    field1 VARCHAR(255),
    field2 INT,
    field3 DECIMAL(10,2),
    
    -- æ ‡å‡†æ§åˆ¶å­—æ®µ
    is_deleted TINYINT DEFAULT 0,                   -- åˆ é™¤æ ‡è¯†ï¼š0-æ­£å¸¸ï¼Œ1-åˆ é™¤
    status TINYINT DEFAULT 1,                       -- çŠ¶æ€æ ‡è¯†ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨
    version INT DEFAULT 1,                          -- ç‰ˆæœ¬å·
    
    -- æ ‡å‡†æ—¶é—´å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  -- åˆ›å»ºæ—¶é—´
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP   -- æ›´æ–°æ—¶é—´
        ON UPDATE CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•å®šä¹‰
    UNIQUE KEY uk_business_key (business_key),       -- ä¸šåŠ¡é”®å”¯ä¸€ç´¢å¼•
    INDEX idx_status_deleted (status, is_deleted),  -- çŠ¶æ€è¿‡æ»¤ç´¢å¼•
    INDEX idx_updated_at (updated_at)               -- æ›´æ–°æ—¶é—´ç´¢å¼•
);
```

### 4.3 ç¼“å­˜é…ç½®è§„èŒƒ

#### 4.3.1 ç¼“å­˜å‚æ•°é…ç½®
```sql
-- ç»´è¡¨è¿æ¥å™¨ç¼“å­˜é…ç½®æ¨¡æ¿
CREATE TABLE dim_table (
    -- å­—æ®µå®šä¹‰
) WITH (
    'connector' = 'jdbc',
    'url' = 'jdbc:mysql://localhost:3306/database',
    'table-name' = 'dim_table',
    
    -- ç¼“å­˜é…ç½®ï¼ˆæ ¸å¿ƒï¼‰
    'lookup.cache.max-rows' = '100000',             -- æœ€å¤§ç¼“å­˜è¡Œæ•°
    'lookup.cache.ttl' = '1 hour',                  -- ç¼“å­˜ç”Ÿå­˜æ—¶é—´
    'lookup.cache.caching-missing-key' = 'true',    -- ç¼“å­˜ç©ºç»“æœ
    
    -- æ€§èƒ½é…ç½®
    'lookup.max-retries' = '3',                     -- æœ€å¤§é‡è¯•æ¬¡æ•°
    'connection.max-retry-timeout' = '60s',         -- è¿æ¥è¶…æ—¶æ—¶é—´
    
    -- è¿æ¥æ± é…ç½®
    'connection.pool.initial-size' = '5',           -- åˆå§‹è¿æ¥æ•°
    'connection.pool.max-size' = '20',              -- æœ€å¤§è¿æ¥æ•°
    'connection.pool.max-idle-timeout' = '300s'     -- è¿æ¥ç©ºé—²è¶…æ—¶
);
```

#### 4.3.2 ç¼“å­˜ç­–ç•¥é€‰æ‹©

**ç¼“å­˜ç­–ç•¥å†³ç­–æµç¨‹**ï¼š
```
ç»´è¡¨æ•°æ®ç‰¹å¾åˆ†æ
        â”‚
        â–¼
    æ›´æ–°é¢‘ç‡åˆ¤æ–­
        â”‚
  â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
  â”‚     â”‚     â”‚
  â–¼     â–¼     â–¼
< 1å°æ—¶  1-24å°æ—¶  > 24å°æ—¶
  â”‚     â”‚     â”‚
  â–¼     â–¼     â–¼
åŠ¨æ€ç»´è¡¨  å‡†é™æ€ç»´è¡¨  é™æ€ç»´è¡¨
  â”‚     â”‚     â”‚
  â–¼     â–¼     â–¼
TTL:5-30åˆ†é’Ÿ  TTL:1-6å°æ—¶  TTL:1-7å¤©
ç¼“å­˜:10K-50K  ç¼“å­˜:50K-200K  ç¼“å­˜:200K+
  â”‚     â”‚     â”‚
  â–¼     â–¼     â–¼
å®æ—¶æ€§è¦æ±‚é«˜  å¹³è¡¡æ€§èƒ½å®æ—¶æ€§  æ€§èƒ½ä¼˜å…ˆ
```

**ç­–ç•¥é€‰æ‹©å‚è€ƒ**ï¼š
| ç»´è¡¨ç±»å‹ | æ›´æ–°é¢‘ç‡ | TTLé…ç½® | ç¼“å­˜è¡Œæ•° | é€‚ç”¨åœºæ™¯ |
|----------|----------|---------|----------|----------|
| **åŠ¨æ€ç»´è¡¨** | < 1å°æ—¶ | 5-30åˆ†é’Ÿ | 10K-50K | å®æ—¶é…ç½®ã€çŠ¶æ€è¡¨ |
| **å‡†é™æ€ç»´è¡¨** | 1-24å°æ—¶ | 1-6å°æ—¶ | 50K-200K | ç”¨æˆ·ä¿¡æ¯ã€äº§å“ä¿¡æ¯ |
| **é™æ€ç»´è¡¨** | > 24å°æ—¶ | 1-7å¤© | 200K+ | åœ°åŒºã€å­¦ç§‘ç­‰å­—å…¸è¡¨ |

### 4.4 ç»´è¡¨æ•°æ®è´¨é‡è§„èŒƒ

#### 4.4.1 æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
```sql
-- ç»´è¡¨æ•°æ®è´¨é‡ç›‘æ§SQL
SELECT 
    table_name,
    total_rows,
    deleted_rows,
    active_rows,
    null_key_rows,
    duplicate_key_rows,
    last_update_time
FROM (
    SELECT 
        'dim_table_name' as table_name,
        COUNT(*) as total_rows,
        SUM(CASE WHEN is_deleted = 1 THEN 1 ELSE 0 END) as deleted_rows,
        SUM(CASE WHEN is_deleted = 0 THEN 1 ELSE 0 END) as active_rows,
        SUM(CASE WHEN business_key IS NULL THEN 1 ELSE 0 END) as null_key_rows,
        COUNT(*) - COUNT(DISTINCT business_key) as duplicate_key_rows,
        MAX(updated_at) as last_update_time
    FROM dim_table_name
) quality_check;
```

#### 4.4.2 ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§
```java
// Flink ç»´è¡¨ç¼“å­˜ç›‘æ§æŒ‡æ ‡
public class DimTableCacheMetrics {
    private Counter cacheHitCounter;      // ç¼“å­˜å‘½ä¸­è®¡æ•°
    private Counter cacheMissCounter;     // ç¼“å­˜æœªå‘½ä¸­è®¡æ•°
    private Counter cacheLoadCounter;     // ç¼“å­˜åŠ è½½è®¡æ•°
    private Histogram cacheLoadTime;     // ç¼“å­˜åŠ è½½æ—¶é—´
    
    public void recordCacheHit() {
        cacheHitCounter.inc();
    }
    
    public void recordCacheMiss() {
        cacheMissCounter.inc();
    }
    
    public double getCacheHitRate() {
        long hits = cacheHitCounter.getCount();
        long total = hits + cacheMissCounter.getCount();
        return total > 0 ? (double) hits / total : 0.0;
    }
}
```

---

## ğŸ“Š Flinkä½œä¸šERå…³ç³»å›¾

### 5.1 å…¸å‹ä½œä¸šERå›¾ç¤ºä¾‹

#### 5.1.1 é”™é¢˜æœ¬å®½è¡¨ä½œä¸šERå›¾

**è¡¨å…³ç³»ç»“æ„å›¾**ï¼š
```
                           é”™é¢˜æœ¬å®½è¡¨ä½œä¸š ER å…³ç³»å›¾
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                æºè¡¨                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ wrongbook_fix (é”™é¢˜ä¿®æ­£äº‹ä»¶)                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ eventId (PK)          â”‚ äº‹ä»¶ID                                          â”‚ â”‚
â”‚ â”‚ fixId (UK)            â”‚ ä¿®æ­£è®°å½•ID                                       â”‚ â”‚
â”‚ â”‚ wrongId (FK)          â”‚ åŸé”™é¢˜è®°å½•ID â†’ wrong_question_record.id          â”‚ â”‚
â”‚ â”‚ userId (FK)           â”‚ ç”¨æˆ·ID                                          â”‚ â”‚
â”‚ â”‚ questionId (FK)       â”‚ é¢˜ç›®ID                                          â”‚ â”‚
â”‚ â”‚ patternId (FK)        â”‚ çŸ¥è¯†ç‚¹ID                                         â”‚ â”‚
â”‚ â”‚ fixResult             â”‚ ä¿®æ­£ç»“æœ                                         â”‚ â”‚
â”‚ â”‚ submitTime            â”‚ æäº¤æ—¶é—´                                         â”‚ â”‚
â”‚ â”‚ eventTime             â”‚ äº‹ä»¶æ—¶é—´                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼ (wrongId â†’ id)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                ç»´è¡¨1                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ wrong_question_record (é”™é¢˜è®°å½•è¡¨)                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ id (PK)               â”‚ é”™é¢˜è®°å½•ID                                       â”‚ â”‚
â”‚ â”‚ userId (FK)           â”‚ ç”¨æˆ·ID                                          â”‚ â”‚
â”‚ â”‚ questionId (FK)       â”‚ é¢˜ç›®ID                                          â”‚ â”‚
â”‚ â”‚ patternId (FK)        â”‚ çŸ¥è¯†ç‚¹ID â†’ tower_pattern.id                     â”‚ â”‚
â”‚ â”‚ subject               â”‚ å­¦ç§‘                                            â”‚ â”‚
â”‚ â”‚ chapterId (FK)        â”‚ ç« èŠ‚ID                                          â”‚ â”‚
â”‚ â”‚ createTime            â”‚ åˆ›å»ºæ—¶é—´                                         â”‚ â”‚
â”‚ â”‚ isDeleted             â”‚ åˆ é™¤æ ‡è¯†                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼ (patternId â†’ id)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                ç»´è¡¨2                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ tower_pattern (çŸ¥è¯†ç‚¹è¡¨)                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ id (PK)               â”‚ çŸ¥è¯†ç‚¹ID                                         â”‚ â”‚
â”‚ â”‚ name                  â”‚ çŸ¥è¯†ç‚¹åç§°                                       â”‚ â”‚
â”‚ â”‚ subject               â”‚ å­¦ç§‘                                            â”‚ â”‚
â”‚ â”‚ type                  â”‚ çŸ¥è¯†ç‚¹ç±»å‹                                       â”‚ â”‚
â”‚ â”‚ difficulty            â”‚ éš¾åº¦ç³»æ•°                                         â”‚ â”‚
â”‚ â”‚ modifyTime            â”‚ ä¿®æ”¹æ—¶é—´                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼ (id â†’ ptId)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                ç»´è¡¨3                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ tower_teaching_type_pt (æ•™å­¦ç±»å‹-çŸ¥è¯†ç‚¹å…³è”è¡¨)                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ id (PK)               â”‚ å…³è”ID                                          â”‚ â”‚
â”‚ â”‚ teachingTypeId (FK)   â”‚ æ•™å­¦ç±»å‹ID â†’ tower_teaching_type.id             â”‚ â”‚
â”‚ â”‚ ptId (FK)             â”‚ çŸ¥è¯†ç‚¹ID                                         â”‚ â”‚
â”‚ â”‚ orderNum              â”‚ æ’åºå·                                          â”‚ â”‚
â”‚ â”‚ isDeleted             â”‚ åˆ é™¤æ ‡è¯†                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼ (teachingTypeId â†’ id)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                ç»´è¡¨4                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ tower_teaching_type (æ•™å­¦ç±»å‹è¡¨)                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ id (PK)               â”‚ æ•™å­¦ç±»å‹ID                                       â”‚ â”‚
â”‚ â”‚ chapterId (FK)        â”‚ ç« èŠ‚ID                                          â”‚ â”‚
â”‚ â”‚ teachingTypeName      â”‚ æ•™å­¦ç±»å‹åç§°                                     â”‚ â”‚
â”‚ â”‚ isDeleted             â”‚ åˆ é™¤æ ‡è¯†                                         â”‚ â”‚
â”‚ â”‚ modifyTime            â”‚ ä¿®æ”¹æ—¶é—´                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼ (æ•°æ®å¤„ç†)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               ç»“æœè¡¨                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ dwd_wrong_record_wide_delta (é”™é¢˜æœ¬å®½è¡¨)                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ id (PK)               â”‚ å®½è¡¨ä¸»é”®                                         â”‚ â”‚
â”‚ â”‚ wrongId               â”‚ é”™é¢˜è®°å½•ID                                       â”‚ â”‚
â”‚ â”‚ userId                â”‚ ç”¨æˆ·ID                                          â”‚ â”‚
â”‚ â”‚ subject               â”‚ å­¦ç§‘                                            â”‚ â”‚
â”‚ â”‚ subjectName           â”‚ å­¦ç§‘åç§°                                         â”‚ â”‚
â”‚ â”‚ questionId            â”‚ é¢˜ç›®ID                                          â”‚ â”‚
â”‚ â”‚ patternId             â”‚ çŸ¥è¯†ç‚¹ID                                         â”‚ â”‚
â”‚ â”‚ patternName           â”‚ çŸ¥è¯†ç‚¹åç§°                                       â”‚ â”‚
â”‚ â”‚ teachingTypeId        â”‚ æ•™å­¦ç±»å‹ID                                       â”‚ â”‚
â”‚ â”‚ teachingTypeName      â”‚ æ•™å­¦ç±»å‹åç§°                                     â”‚ â”‚
â”‚ â”‚ collectTime           â”‚ æ”¶é›†æ—¶é—´                                         â”‚ â”‚
â”‚ â”‚ fixId                 â”‚ ä¿®æ­£è®°å½•ID                                       â”‚ â”‚
â”‚ â”‚ fixTime               â”‚ ä¿®æ­£æ—¶é—´                                         â”‚ â”‚
â”‚ â”‚ fixResult             â”‚ ä¿®æ­£ç»“æœ                                         â”‚ â”‚
â”‚ â”‚ fixResultDesc         â”‚ ä¿®æ­£ç»“æœæè¿°                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.1.2 ç”¨æˆ·æ—¥ç»Ÿè®¡ä½œä¸šERå›¾

**å¤šæºè¡¨èšåˆå…³ç³»å›¾**ï¼š
```
                          ç”¨æˆ·æ—¥ç»Ÿè®¡ä½œä¸š ER å…³ç³»å›¾ (å¤šæºèšåˆ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å¤šæºè¡¨å®šä¹‰                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  wrongbook_fix      â”‚   answer_submit     â”‚      user_login                 â”‚
â”‚  (é”™é¢˜ä¿®æ­£äº‹ä»¶)      â”‚   (ç­”é¢˜æäº¤äº‹ä»¶)     â”‚     (ç”¨æˆ·ç™»å½•äº‹ä»¶)               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚eventId (PK)     â”‚ â”‚ â”‚eventId (PK)     â”‚ â”‚ â”‚eventId (PK)                 â”‚ â”‚
â”‚ â”‚userId (FK)      â”‚ â”‚ â”‚userId (FK)      â”‚ â”‚ â”‚userId (FK)                  â”‚ â”‚
â”‚ â”‚fixResult        â”‚ â”‚ â”‚isCorrect        â”‚ â”‚ â”‚deviceType                   â”‚ â”‚
â”‚ â”‚eventTime        â”‚ â”‚ â”‚answerTime       â”‚ â”‚ â”‚eventTime                    â”‚ â”‚
â”‚ â”‚eventDate        â”‚ â”‚ â”‚eventTime        â”‚ â”‚ â”‚eventDate                    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚eventDate        â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚                     â”‚
          â–¼ (userId)            â–¼ (userId)            â–¼ (userId)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               ç»´è¡¨                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ user_profile (ç”¨æˆ·æ¡£æ¡ˆè¡¨)                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ userId (PK)           â”‚ ç”¨æˆ·ID                                          â”‚ â”‚
â”‚ â”‚ userName              â”‚ ç”¨æˆ·åç§°                                         â”‚ â”‚
â”‚ â”‚ grade                 â”‚ å¹´çº§                                            â”‚ â”‚
â”‚ â”‚ school                â”‚ å­¦æ ¡                                            â”‚ â”‚
â”‚ â”‚ createTime            â”‚ åˆ›å»ºæ—¶é—´                                         â”‚ â”‚
â”‚ â”‚ isActive              â”‚ æ˜¯å¦æ´»è·ƒ                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼ (æŒ‰æ—¥æœŸèšåˆç»Ÿè®¡)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç»“æœè¡¨                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ dws_user_daily_stats (ç”¨æˆ·æ—¥ç»Ÿè®¡è¡¨)                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ id (PK)               â”‚ ç»Ÿè®¡ä¸»é”®                                         â”‚ â”‚
â”‚ â”‚ userId (FK)           â”‚ ç”¨æˆ·ID                                          â”‚ â”‚
â”‚ â”‚ userName              â”‚ ç”¨æˆ·åç§° (æ¥è‡ªuser_profile)                      â”‚ â”‚
â”‚ â”‚ grade                 â”‚ å¹´çº§ (æ¥è‡ªuser_profile)                         â”‚ â”‚
â”‚ â”‚ statDate              â”‚ ç»Ÿè®¡æ—¥æœŸ                                         â”‚ â”‚
â”‚ â”‚ loginCount            â”‚ ç™»å½•æ¬¡æ•° (æ¥è‡ªuser_loginèšåˆ)                    â”‚ â”‚
â”‚ â”‚ answerCount           â”‚ ç­”é¢˜æ•°é‡ (æ¥è‡ªanswer_submitèšåˆ)                 â”‚ â”‚
â”‚ â”‚ correctCount          â”‚ æ­£ç¡®ç­”é¢˜æ•° (æ¥è‡ªanswer_submitèšåˆ)               â”‚ â”‚
â”‚ â”‚ correctRate           â”‚ æ­£ç¡®ç‡ (è®¡ç®—å­—æ®µ)                                â”‚ â”‚
â”‚ â”‚ totalAnswerTime       â”‚ æ€»ç­”é¢˜æ—¶é•¿ (æ¥è‡ªanswer_submitèšåˆ)               â”‚ â”‚
â”‚ â”‚ fixCount              â”‚ ä¿®æ­£æ¬¡æ•° (æ¥è‡ªwrongbook_fixèšåˆ)                 â”‚ â”‚
â”‚ â”‚ updateTime            â”‚ æ›´æ–°æ—¶é—´                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**èšåˆé€»è¾‘è¯´æ˜**ï¼š
- **æ•°æ®å…³è”**ï¼šä¸‰ä¸ªæºè¡¨é€šè¿‡ userId å…³è”åˆ°åŒä¸€ç”¨æˆ·
- **æ—¶é—´çª—å£**ï¼šæŒ‰ eventDate è¿›è¡Œå¤©çº§åˆ«èšåˆç»Ÿè®¡
- **æŒ‡æ ‡è®¡ç®—**ï¼š
  - `loginCount`: COUNT(user_login events)
  - `answerCount`: COUNT(answer_submit events) 
  - `correctCount`: COUNT(answer_submit events WHERE isCorrect = 1)
  - `correctRate`: correctCount / answerCount
  - `totalAnswerTime`: SUM(answerTime)
  - `fixCount`: COUNT(wrongbook_fix events)

### 5.2 ERå›¾è®¾è®¡è§„èŒƒ

#### 5.2.1 å…³è”å…³ç³»ç±»å‹å®šä¹‰
| å…³ç³»ç¬¦å· | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|----------|------|----------|------|
| `||--||` | ä¸€å¯¹ä¸€ | ä¸»è¡¨ä¸æ‰©å±•è¡¨ | ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ â†” ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ |
| `||--o{` | ä¸€å¯¹å¤š | ä¸»è¡¨ä¸å­è¡¨ | ç”¨æˆ· â†” è®¢å•è®°å½• |
| `}o--||` | å¤šå¯¹ä¸€ | äº‹å®è¡¨ä¸ç»´è¡¨ | è®¢å• â†” ç”¨æˆ·ä¿¡æ¯ |
| `}o--o{` | å¤šå¯¹å¤š | å…³è”è¡¨å…³ç³» | å­¦ç”Ÿ â†” è¯¾ç¨‹ï¼ˆé€šè¿‡é€‰è¯¾è¡¨ï¼‰ |

#### 5.2.2 å¤–é”®å…³è”å‘½åè§„èŒƒ
```yaml
foreign_key_naming:
  pattern: "{target_table}_{target_field}"
  examples:
    - "userId -> user_profile.userId"          # ç”¨æˆ·ä¿¡æ¯å…³è”
    - "questionId -> question_info.questionId" # é¢˜ç›®ä¿¡æ¯å…³è”
    - "patternId -> tower_pattern.id"          # çŸ¥è¯†ç‚¹ä¿¡æ¯å…³è”
    
constraint_naming:
  pattern: "fk_{source_table}_{target_table}_{field}"
  examples:
    - "fk_wrongbook_fix_wrong_question_record_wrongId"
    - "fk_answer_submit_user_profile_userId"
```

#### 5.2.3 ERå›¾è´¨é‡æ£€æŸ¥æ¸…å•
```yaml
er_quality_checklist:
  completeness:
    - "æ‰€æœ‰æºè¡¨éƒ½å·²å®šä¹‰"
    - "æ‰€æœ‰ç»´è¡¨éƒ½å·²åŒ…å«"
    - "ç»“æœè¡¨ç»“æ„å®Œæ•´"
    
  consistency:
    - "å­—æ®µç±»å‹ä¸€è‡´"
    - "å‘½åè§„èŒƒç»Ÿä¸€"
    - "å…³è”å…³ç³»æ˜ç¡®"
    
  performance:
    - "å…³è”å­—æ®µæœ‰ç´¢å¼•"
    - "é¿å…ç¬›å¡å°”ç§¯"
    - "JOINè·¯å¾„æœ€çŸ­"
    
  maintainability:
    - "å…³ç³»å›¾æ¸…æ™°æ˜“è¯»"
    - "æ³¨é‡Šè¯´æ˜å®Œæ•´"
    - "ç‰ˆæœ¬å˜æ›´å¯è¿½è¸ª"
```

---

## ğŸ”§ å¼€å‘æœ€ä½³å®è·µ

### 6.1 æ€§èƒ½ä¼˜åŒ–æŒ‡å—

#### 6.1.1 Flink SQLä¼˜åŒ–ç­–ç•¥
```sql
-- 1. åˆç†ä½¿ç”¨çª—å£å‡½æ•°
SELECT 
    userId,
    COUNT(*) as answer_count,
    AVG(answerTime) as avg_answer_time
FROM answer_submit
WHERE eventTime BETWEEN 
    INTERVAL '1' DAY PRECEDING AND CURRENT ROW
GROUP BY userId;

-- 2. ä¼˜åŒ–JOINé¡ºåºï¼ˆå°è¡¨åœ¨å‰ï¼‰
SELECT s.*, d1.name, d2.type
FROM small_stream_table s
LEFT JOIN small_dim_table d1 ON s.key1 = d1.id
LEFT JOIN large_dim_table d2 ON s.key2 = d2.id;

-- 3. ä½¿ç”¨åˆ—æŠ•å½±å‡å°‘æ•°æ®ä¼ è¾“
SELECT 
    userId, questionId, submitTime  -- åªé€‰æ‹©éœ€è¦çš„å­—æ®µ
FROM answer_submit
WHERE eventTime > CURRENT_TIMESTAMP - INTERVAL '1' DAY;
```

#### 6.1.2 çŠ¶æ€ç®¡ç†ä¼˜åŒ–
```java
// 1. åˆç†è®¾ç½®çŠ¶æ€TTL
StateTtlConfig ttlConfig = StateTtlConfig
    .newBuilder(Time.hours(24))
    .setUpdateType(StateTtlConfig.UpdateType.OnCreateAndWrite)
    .cleanupIncrementally(1000, true)  // å¢é‡æ¸…ç†
    .build();

// 2. ä½¿ç”¨RocksDBçŠ¶æ€åç«¯
Configuration config = new Configuration();
config.setString("state.backend", "rocksdb");
config.setString("state.checkpoints.dir", "hdfs://namenode:port/checkpoints");

// 3. ä¼˜åŒ–åºåˆ—åŒ–
env.getConfig().enableObjectReuse();  // å¯¹è±¡é‡ç”¨
env.getConfig().disableGenericTypes(); // ç¦ç”¨æ³›å‹ç±»å‹
```

### 6.2 ç›‘æ§å’Œå‘Šè­¦

#### 6.2.1 å…³é”®ç›‘æ§æŒ‡æ ‡
```yaml
flink_monitoring_metrics:
  throughput:
    - "records_in_per_second"      # è¾“å…¥è®°å½•æ•°/ç§’
    - "records_out_per_second"     # è¾“å‡ºè®°å½•æ•°/ç§’
    - "bytes_in_per_second"        # è¾“å…¥å­—èŠ‚æ•°/ç§’
    
  latency:
    - "end_to_end_latency"         # ç«¯åˆ°ç«¯å»¶è¿Ÿ
    - "processing_latency"         # å¤„ç†å»¶è¿Ÿ
    - "checkpoint_duration"        # æ£€æŸ¥ç‚¹æ—¶é•¿
    
  reliability:
    - "checkpoint_success_rate"    # æ£€æŸ¥ç‚¹æˆåŠŸç‡
    - "job_restart_count"          # ä½œä¸šé‡å¯æ¬¡æ•°
    - "exception_count"            # å¼‚å¸¸è®¡æ•°
    
  resource:
    - "cpu_utilization"            # CPUä½¿ç”¨ç‡
    - "memory_utilization"         # å†…å­˜ä½¿ç”¨ç‡
    - "gc_time_percentage"         # GCæ—¶é—´å æ¯”
```

#### 6.2.2 å‘Šè­¦è§„åˆ™é…ç½®
```yaml
alerting_rules:
  critical:
    - name: "job_down"
      condition: "flink_job_status != 'RUNNING'"
      duration: "1m"
      action: "immediate_notification"
      
    - name: "high_latency"
      condition: "flink_end_to_end_latency > 10000"  # 10ç§’
      duration: "5m"
      action: "escalation_notification"
      
  warning:
    - name: "checkpoint_failure"
      condition: "flink_checkpoint_success_rate < 0.95"
      duration: "10m"
      action: "team_notification"
      
    - name: "high_cpu"
      condition: "flink_cpu_utilization > 0.8"
      duration: "15m"
      action: "resource_scaling"
```

### 6.3 æ•…éšœå¤„ç†æµç¨‹

#### 6.3.1 å¸¸è§é—®é¢˜è¯Šæ–­

**æ•…éšœè¯Šæ–­å†³ç­–æ ‘**ï¼š
```
Flinkä½œä¸šå¼‚å¸¸
        â”‚
        â–¼
    ä½œä¸šçŠ¶æ€åˆ¤æ–­
        â”‚
  â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
  â”‚     â”‚     â”‚
  â–¼     â–¼     â–¼
FAILED  RESTARTING  RUNNINGä½†æ— è¾“å‡º
  â”‚     â”‚     â”‚
  â–¼     â–¼     â–¼
æ£€æŸ¥å¼‚å¸¸æ—¥å¿—  æ£€æŸ¥é‡å¯åŸå›   æ£€æŸ¥æ•°æ®æº
  â”‚     â”‚     â”‚
  â–¼     â–¼     â–¼
å¼‚å¸¸ç±»å‹åˆ†æ  é‡å¯é¢‘ç‡åˆ†æ  æ•°æ®æµçŠ¶æ€åˆ†æ
  â”‚     â”‚     â”‚
â”Œâ”€â”¼â”€â”   â”Œâ”€â”¼â”€â”   â”Œâ”€â”¼â”€â”
â”‚ â”‚ â”‚   â”‚ â”‚ â”‚   â”‚ â”‚ â”‚
â–¼ â–¼ â–¼   â–¼ â–¼ â–¼   â–¼ â–¼ â–¼
åºåˆ—åŒ–  èµ„æº  è¿æ¥  é¢‘ç¹  å¶å‘  æºå¤´  æ°´ä½çº¿
å¼‚å¸¸   ä¸è¶³  å¼‚å¸¸  é‡å¯  é‡å¯  æ— æ•°æ® åœæ­¢
â”‚     â”‚   â”‚   â”‚   â”‚   â”‚    â”‚
â–¼     â–¼   â–¼   â–¼   â–¼   â–¼    â–¼
æ£€æŸ¥   è°ƒæ•´  æ£€æŸ¥  æ£€æŸ¥  æ£€æŸ¥  æ£€æŸ¥   æ£€æŸ¥
æ•°æ®   å¹¶è¡Œåº¦ å¤–éƒ¨  æ£€æŸ¥ç‚¹ èµ„æº  ä¸Šæ¸¸   äº‹ä»¶æ—¶é—´
æ ¼å¼   å†…å­˜  ä¾èµ–  é…ç½®  ç¨³å®šæ€§ ç³»ç»Ÿ   é…ç½®
```

**æ•…éšœåˆ†ç±»å¤„ç†**ï¼š
| æ•…éšœç±»å‹ | æ£€æŸ¥é‡ç‚¹ | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| **åºåˆ—åŒ–å¼‚å¸¸** | æ•°æ®æ ¼å¼ã€Payloadç±» | æ£€æŸ¥JSONç»“æ„ã€ç±»å®šä¹‰ |
| **èµ„æºä¸è¶³** | CPUã€å†…å­˜ä½¿ç”¨ç‡ | è°ƒæ•´å¹¶è¡Œåº¦ã€å¢åŠ èµ„æº |
| **è¿æ¥å¼‚å¸¸** | ç½‘ç»œã€æ•°æ®åº“è¿æ¥ | æ£€æŸ¥è¿æ¥é…ç½®ã€ç½‘ç»œçŠ¶æ€ |
| **é¢‘ç¹é‡å¯** | æ£€æŸ¥ç‚¹å¤±è´¥ã€èµ„æºæŠ¢å  | ä¼˜åŒ–æ£€æŸ¥ç‚¹é…ç½® |
| **æ•°æ®æºé—®é¢˜** | ä¸Šæ¸¸æ•°æ®ã€æ°´ä½çº¿ | æ£€æŸ¥æ•°æ®äº§ç”Ÿã€æ—¶é—´é…ç½® |

#### 6.3.2 åº”æ€¥å¤„ç†æ ‡å‡†
```yaml
incident_response:
  severity_levels:
    P0_critical:
      description: "æ ¸å¿ƒä¸šåŠ¡å®Œå…¨ä¸­æ–­"
      response_time: "5åˆ†é’Ÿ"
      resolution_time: "30åˆ†é’Ÿ"
      actions:
        - "ç«‹å³å›æ»šåˆ°ç¨³å®šç‰ˆæœ¬"
        - "å¯åŠ¨åº”æ€¥é¢„æ¡ˆ"
        - "é€šçŸ¥æ‰€æœ‰ç›¸å…³æ–¹"
        
    P1_high:
      description: "åŠŸèƒ½å¼‚å¸¸å½±å“ä¸šåŠ¡"
      response_time: "15åˆ†é’Ÿ"
      resolution_time: "2å°æ—¶"
      actions:
        - "åˆ†ææ ¹å› "
        - "åˆ¶å®šä¿®å¤æ–¹æ¡ˆ"
        - "ç›‘æ§ä¿®å¤æ•ˆæœ"
        
    P2_medium:
      description: "æ€§èƒ½ä¸‹é™æˆ–éƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸"
      response_time: "1å°æ—¶"
      resolution_time: "1ä¸ªå·¥ä½œæ—¥"
      actions:
        - "è®°å½•é—®é¢˜è¯¦æƒ…"
        - "æ’æœŸä¿®å¤"
        - "æŒç»­ç›‘æ§"
```

---

## ğŸ“š é™„å½•

### A. ä»£ç æ¨¡æ¿

#### A.1 æ ‡å‡†Flink SQLä½œä¸šæ¨¡æ¿
```sql
-- =============================================
-- Flink SQLä½œä¸šæ ‡å‡†æ¨¡æ¿
-- ä½œä¸šåç§°ï¼š{job_name}
-- ä¸šåŠ¡åŸŸï¼š{domain}
-- åˆ›å»ºæ—¶é—´ï¼š{create_date}
-- =============================================

-- 1. è®¾ç½®ä½œä¸šçº§åˆ«é…ç½®
SET 'table.exec.state.ttl' = '86400000';  -- 24å°æ—¶çŠ¶æ€TTL
SET 'table.exec.mini-batch.enabled' = 'true';
SET 'table.exec.mini-batch.allow-latency' = '1s';
SET 'table.exec.mini-batch.size' = '1000';

-- 2. åˆ›å»ºæºè¡¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
CREATE TABLE IF NOT EXISTS source_table (
    -- å­—æ®µå®šä¹‰
    event_time AS TO_TIMESTAMP_LTZ(event_timestamp, 0),
    WATERMARK FOR event_time AS event_time - INTERVAL '5' SECOND
) WITH (
    'connector' = 'kafka',
    -- è¿æ¥å™¨é…ç½®
);

-- 3. ä¸»SQLé€»è¾‘
INSERT INTO {result_table}
SELECT 
    -- å­—æ®µæ˜ å°„
FROM {source_table} s
LEFT JOIN {dim_table_1} FOR SYSTEM_TIME AS OF PROCTIME() d1
    ON s.key1 = d1.id
LEFT JOIN {dim_table_2} FOR SYSTEM_TIME AS OF PROCTIME() d2  
    ON s.key2 = d2.id
WHERE s.domain = '{domain}'
  AND s.type = '{event_type}'
  AND d1.is_deleted = false
  AND d2.is_deleted = false;
```

### B. é…ç½®æ–‡ä»¶æ¨¡æ¿

#### B.1 ä½œä¸šé…ç½®æ¨¡æ¿
```yaml
# Flinkä½œä¸šé…ç½®æ¨¡æ¿
job_config:
  name: "{domain}_wide_table_job"
  description: "{domain}åŸŸå®æ—¶å®½è¡¨å¤„ç†ä½œä¸š"
  
  # è¿è¡Œæ—¶é…ç½®
  runtime:
    parallelism: 2
    max_parallelism: 128
    restart_strategy: "fixed-delay"
    restart_attempts: 3
    restart_delay: "30s"
    
  # æ£€æŸ¥ç‚¹é…ç½®
  checkpoint:
    interval: "60s"
    timeout: "300s"
    min_pause: "10s"
    max_concurrent: 1
    cleanup_mode: "RETAIN_ON_CANCELLATION"
    
  # çŠ¶æ€åç«¯é…ç½®
  state_backend:
    type: "rocksdb"
    checkpoint_dir: "hdfs://namenode:port/checkpoints/{domain}"
    
  # èµ„æºé…ç½®
  resources:
    jobmanager:
      memory: "2048mb"
      cpu: 1
    taskmanager:
      memory: "4096mb" 
      cpu: 2
      slots: 2
```

### C. æ•…éšœæ’æŸ¥æ‰‹å†Œ

#### C.1 å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ
| é”™è¯¯ç±»å‹ | é”™è¯¯ä¿¡æ¯ | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| **åºåˆ—åŒ–é”™è¯¯** | `Could not serialize` | æ£€æŸ¥Payloadç±»æ˜¯å¦å®ç°Serializable |
| **æ°´ä½çº¿åœæ»** | `Watermark not advancing` | æ£€æŸ¥äº‹ä»¶æ—¶é—´å­—æ®µé…ç½®å’Œæ•°æ®äº§ç”Ÿ |
| **å†…å­˜æº¢å‡º** | `OutOfMemoryError` | å¢åŠ TaskManagerå†…å­˜æˆ–è°ƒæ•´å¹¶è¡Œåº¦ |
| **æ£€æŸ¥ç‚¹å¤±è´¥** | `Checkpoint failure` | æ£€æŸ¥HDFSè¿æ¥å’Œç£ç›˜ç©ºé—´ |
| **ç»´è¡¨è¿æ¥è¶…æ—¶** | `JDBC connection timeout` | æ£€æŸ¥æ•°æ®åº“è¿æ¥é…ç½®å’Œç½‘ç»œ |

---

## ğŸ“ è”ç³»æˆ‘ä»¬

### æŠ€æœ¯æ”¯æŒ
- **æŠ€æœ¯æ–‡æ¡£**ï¼š[å†…éƒ¨æ–‡æ¡£å¹³å°é“¾æ¥]
- **é—®é¢˜åé¦ˆ**ï¼š[JIRA/GitHub Issuesé“¾æ¥]  
- **æŠ€æœ¯è®¨è®º**ï¼š[ä¼ä¸šå¾®ä¿¡ç¾¤/é’‰é’‰ç¾¤]

### ç‰ˆæœ¬æ›´æ–°
- **å½“å‰ç‰ˆæœ¬**ï¼šv3.0
- **æ›´æ–°æ—¥æœŸ**ï¼š2024-12-27
- **ä¸‹æ¬¡æ›´æ–°**ï¼š2024-01-15

---

**éµå¾ªè§„èŒƒï¼Œæ„å»ºé«˜è´¨é‡çš„å®æ—¶æ•°æ®å¤„ç†ä½“ç³»ï¼** ğŸš€
