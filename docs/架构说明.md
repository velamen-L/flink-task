# Flink实时计算混合架构完整说明

## 🎯 架构概述

本项目采用**混合动态路由架构**，支持单topic多子类型的事件处理，具备动态路由、热更新、故障隔离等企业级特性。


### 架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   业务系统      │    │   Kafka集群     │    │   Flink集群     │
│                │    │                │    │                │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ 业务事件    │ │───▶│ │ 统一Topic   │ │───▶│ │ 事件源      │ │
│ │ 生成        │ │    │ │ wrongbook-  │ │    │ │ KafkaSource │ │
│ └─────────────┘ │    │ │ events      │ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘    │                │
                                              │ ┌─────────────┐ │
                                              │ │ 动态路由    │ │
                                              │ │ 配置源      │ │
                                              │ │ MySQL       │ │
                                              │ └─────────────┘ │
                                              │                │
                                              │ ┌─────────────┐ │
                                              │ │ 动态路由    │ │
                                              │ │ 处理器      │ │
                                              │ └─────────────┘ │
                                              │                │
                                              │ ┌─────────────┐ │
                                              │ │ 维表关联    │ │
                                              │ │ Broadcast   │ │
                                              │ └─────────────┘ │
                                              │                │
                                              │ ┌─────────────┐ │
                                              │ │ 输出路由    │ │
                                              │ │ 处理器      │ │
                                              │ └─────────────┘ │
                                              └─────────────────┘
                                                       │
                                                       ▼
                                              ┌─────────────────┐
                                              │   数据输出      │
                                              │                │
                                              │ ┌─────────────┐ │
                                              │ │ MySQL宽表   │ │
                                              │ │ 主流输出    │ │
                                              │ └─────────────┘ │
                                              │                │
                                              │ ┌─────────────┐ │
                                              │ │ 告警Topic   │ │
                                              │ │ 侧流输出    │ │
                                              │ └─────────────┘ │
                                              │                │
                                              │ ┌─────────────┐ │
                                              │ │ 指标Topic   │ │
                                              │ │ 侧流输出    │ │
                                              │ └─────────────┘ │
                                              └─────────────────┘
```


## 🏗️ 核心架构组件

### 1. 统一事件模型

```java
// BusinessEvent - 统一事件格式（二级路由）
{
  "domain": "wrongbook",           // 业务域（topic）
  "type": "wrongbook_add",         // 事件类型
  "eventId": "uuid",               // 事件ID
  "timestamp": 1640995200000,      // 事件时间戳
  "payload": { /* 业务数据 */ },    // 载荷数据
  "version": "1.0",                // 数据版本
  "source": "app"                  // 来源系统
}
```

### 2. 二级动态路由

精简高效的二级路由架构：

```
domain:type  (精确匹配)
例: wrongbook:wrongbook_add
   wrongbook:wrongbook_fix
   wrongbook:wrongbook_delete
```

**路由优势**：
- ✅ 简单高效：减少路由复杂度
- ✅ 性能优化：更快的匹配速度
- ✅ 易于维护：清晰的事件类型层级
- ✅ 扩展友好：支持processor内部子类型处理

### 3. 通用入口架构

```java
// CommonWideTableApp - 通用作业入口
CommonWideTableApp.execute(topic, mysqlSink, kafkaSink);

// 功能特性：
- 统一的事件处理流程
- 支持MySQL和Kafka双输出
- 自动配置动态路由
- 完整的监控和异常处理
```

### 4. 维表查询服务

```java
// DimTableQueryService - 通用维表查询
DimTableQueryService dimService = DimTableQueryService.getInstance();

// 带缓存查询
Map<String, Object> patternInfo = dimService.queryWithCache(
    "pattern_info", patternId,
    "SELECT * FROM pattern_info WHERE pattern_id = ?", patternId);

// 功能特性：
- 自动缓存管理（30分钟TTL）
- 连接池管理
- 批量查询支持
- 异常容错处理
```

### 5. 处理器配置注解

```java
@ProcessorConfig(
    eventTypes = {"wrongbook:wrongbook_add"},
    description = "错题添加事件处理器",
    priority = 1
)
@Component  
public class WrongbookAddProcessor implements EventProcessor<BusinessEvent> {
    
    private final DimTableQueryService dimService = DimTableQueryService.getInstance();
    
    @Override
    public Object process(BusinessEvent event) throws Exception {
        // 1. 解析payload
        // 2. 查询维表数据
        // 3. 构建宽表数据
        // 4. 返回处理结果
    }
}
```

## 📊 数据流架构图

```
Kafka事件源                    动态路由配置           维表数据
(wrongbook-events)            (MySQL广播流)         (MySQL查询)
      │                           │                     │
      ▼                           ▼                     ▼
┌─────────────────────────────────────────────────────────────┐
│              DynamicRoutingProcessFunction                  │
│                                                             │
│  1. 解析事件 domain:type (二级路由)                          │
│  2. 路由键匹配: wrongbook:wrongbook_add                      │
│  3. 获取/创建对应处理器                                      │
│  4. 处理器执行业务逻辑:                                      │
│     - 查询维表数据 (带缓存)                                  │
│     - 构建宽表数据                                          │
│     - 设置输出目标                                          │
│                                                             │
└─────────────┬───────────────────────────────────────────────┘
              │ ProcessedEvent
              ▼
┌─────────────────────────────────────────────────────────────┐
│              OutputRoutingProcessFunction                   │
│                                                             │
│  根据output_config配置分流:                                  │
│  - MySQL输出: sinks包含["mysql", "wide_table"]              │
│  - Kafka输出: sinks包含["kafka", "downstream_topic"]        │
│  - 告警流: 异常事件 → alert-events topic                    │
│  - 指标流: 统计数据 → metrics-events topic                  │
│  - 审计流: 审计数据 → audit-events topic                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────┐
│                     双输出架构                               │
│                                                             │
│  ┌─────────────────┐              ┌─────────────────┐       │
│  │   MySQL宽表      │              │   Kafka下游      │       │
│  │ dwd_wrong_record │              │ wrongbook-wide- │       │
│  │ _wide_delta      │              │ table-output    │       │
│  └─────────────────┘              └─────────────────┘       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 项目目录结构

```
src/main/java/com/flink/realtime/
├── bean/                           # 数据模型
│   ├── BaseBean.java              # 基础数据模型
│   ├── BusinessEvent.java         # 统一事件模型
│   └── ProcessedEvent.java        # 处理结果模型
├── config/                        # 配置管理
│   ├── RoutingConfig.java         # 路由配置模型
│   └── RoutingConfigManager.java  # 配置管理工具
├── enums/                         # 枚举定义
│   └── WrongbookEventType.java    # 错题本事件类型枚举
├── function/                      # Flink函数
│   ├── DynamicRoutingProcessFunction.java  # 动态路由处理
│   └── OutputRoutingProcessFunction.java   # 输出路由处理
├── processor/                     # 事件处理器
│   ├── EventProcessor.java        # 处理器接口
│   ├── ProcessorConfig.java       # 处理器配置注解
│   └── EventProcessorFactory.java # 处理器工厂
├── topics/                        # 业务域实现
│   └── wrongbook/                 # 错题本业务域
│       ├── app/                   # 应用主类
│       ├── bean/                  # 业务数据模型
│       └── processor/             # 业务处理器
├── source/                        # 数据源
├── sink/                          # 数据输出
├── common/                        # 公共工具
└── util/                          # 工具类

topics/                            # 业务需求和文档
└── wrongbook/
    ├── request.md                 # 业务需求文档 (新增)
    └── docs/                      # 业务文档
```

## 🚀 使用方式

### 1. 添加新的事件子类型

**步骤1**: 在枚举中定义新类型
```java
// 在WrongbookEventType.java中添加
WRONGBOOK_ADD_BATCH("wrongbook_add", "batch", "批量添加错题"),
```

**步骤2**: 创建对应处理器（可选）
```java
@ProcessorConfig(eventTypes = {"wrongbook:wrongbook_add:batch"})
@Component  
public class WrongbookAddBatchProcessor implements EventProcessor<BusinessEvent> {
    // 处理逻辑
}
```

**步骤3**: 配置路由（如果需要独立处理器）
```sql
INSERT INTO flink_routing_config (domain, event_type, processor_class, is_enabled)
VALUES ('wrongbook', 'wrongbook_add:batch', 
        'com.flink.realtime.topics.wrongbook.processor.WrongbookAddBatchProcessor', 
        true);
```

### 2. 使用intelligent-job-generator生成代码

**方式1**: 直接描述
```
请使用intelligent-job-generator生成wrongbook业务的Flink作业，
包含wrongbook_add、wrongbook_fix、wrongbook_delete三种事件类型。
```

**方式2**: 使用MD文件（推荐）
```
请根据 topics/wrongbook/request.md 文件生成完整的作业代码
```

## ⚙️ 配置管理

### 动态路由配置表结构

```sql
CREATE TABLE flink_routing_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    domain VARCHAR(50) NOT NULL COMMENT '业务域',
    event_type VARCHAR(100) NOT NULL COMMENT '事件类型（支持子类型）',
    processor_class VARCHAR(200) NOT NULL COMMENT '处理器类名',
    output_config JSON COMMENT '输出配置',
    is_enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    priority INT DEFAULT 100 COMMENT '优先级',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_domain_type (domain, event_type)
);
```

### 配置示例

```sql
-- 主类型配置（兜底处理）
INSERT INTO flink_routing_config (domain, event_type, processor_class) 
VALUES ('wrongbook', 'wrongbook_add', 'com.flink.realtime.topics.wrongbook.processor.WrongbookAddProcessor');

-- 子类型配置（精确处理）
INSERT INTO flink_routing_config (domain, event_type, processor_class)
VALUES ('wrongbook', 'wrongbook_add:manual', 'com.flink.realtime.topics.wrongbook.processor.WrongbookAddManualProcessor');
```

## 🔄 事件处理流程

### 1. 事件接收
```
Kafka → BusinessEvent反序列化 → 时间水印分配
```

### 2. 动态路由匹配
```java
String routingKey = buildRoutingKey(event);
// 优先级: wrongbook:wrongbook_add:manual > wrongbook:wrongbook_add > wrongbook:*

EventProcessor processor = processorFactory.getProcessor(routingKey);
```

### 3. 事件处理
```java
Object result = processor.process(event);
ProcessedEvent processedEvent = new ProcessedEvent(event, result, outputConfig);
```

### 4. 结果输出
```java
// 根据输出配置分流
if (isAlert(processedEvent)) {
    ctx.output(alertTag, processedEvent);
} else if (isMetric(processedEvent)) {
    ctx.output(metricsTag, processedEvent);
} else {
    // 主流输出到宽表
    out.collect(processedEvent);
}
```

## 📈 监控和运维

### 关键指标
- **事件处理吞吐量**: events/sec
- **处理延迟**: P50/P95/P99延迟
- **错误率**: 失败事件比例
- **路由匹配率**: 成功路由的事件比例

### 告警机制
- 处理器执行异常自动告警
- 死信队列消息积压告警
- 处理延迟超阈值告警
- 配置更新失败告警

### 运维操作
```bash
# 查看路由配置
java -cp flink-job.jar com.flink.realtime.config.RoutingConfigManager list wrongbook

# 添加新路由
java -cp flink-job.jar com.flink.realtime.config.RoutingConfigManager add wrongbook wrongbook_add:batch BatchProcessor

# 禁用路由
java -cp flink-job.jar com.flink.realtime.config.RoutingConfigManager disable wrongbook wrongbook_add:manual
```

## 🎯 架构优势

### ✅ 现有优势
1. **动态路由**: 支持热更新，无需重启作业
2. **故障隔离**: 单个处理器异常不影响整体
3. **统一事件模型**: 标准化的事件格式
4. **多输出支持**: 主流、告警流、指标流分离
5. **阿里云深度集成**: 针对阿里云Flink优化

### 🚀 新增优势  
1. **三级路由**: domain:type:subType精确匹配
2. **类型安全**: 枚举管理事件类型，编译时检查
3. **注解驱动**: @ProcessorConfig简化配置
4. **自动发现**: Spring管理的处理器自动注册
5. **MD文件驱动**: 支持标准化的需求文档输入

## 📋 最佳实践

### 1. 事件类型设计
- 主类型表示业务动作：`user_login`、`order_create`
- 子类型表示执行方式：`manual`、`auto`、`batch`
- 保持命名一致性和可读性

### 2. 处理器设计
- 单一职责：每个处理器只处理一类事件
- 幂等性：支持重复处理同一事件
- 异常处理：完善的异常捕获和日志记录

### 3. 配置管理
- 优先使用通用处理器（降低维护成本）
- 必要时才创建专用处理器（精确控制）
- 定期清理无效配置

### 4. 性能优化
- 合理设置并行度和资源配置
- 使用对象池减少GC压力
- 监控关键指标，及时调优

---

**这个架构已经是一个企业级的完善方案，支持灵活的扩展和高效的运维管理！** 🎉
