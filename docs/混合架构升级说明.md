# Flink实时计算项目 - 混合架构升级说明

## 🎯 **升级概述**

本次升级将原有的静态事件处理架构升级为**混合架构**，实现了**动态路由**、**热部署**和**故障隔离**功能，大幅提升了系统的灵活性和可维护性。

## 🚀 **核心改进**

### **1. 动态路由系统**

#### **原架构问题**
- 事件处理逻辑硬编码在代码中
- 新增事件类型需要修改代码并重新发布
- 无法动态调整处理逻辑

#### **新架构解决方案**
- 基于数据库的路由配置表（`flink_routing_config`）
- 30秒内配置热更新，无需重启作业
- 支持处理器优先级和启用/禁用控制

```sql
-- 路由配置表结构
CREATE TABLE flink_routing_config (
    domain VARCHAR(50),           -- 业务域
    event_type VARCHAR(100),      -- 事件类型
    processor_class VARCHAR(200), -- 处理器类名
    output_config JSON,           -- 输出配置
    is_enabled BOOLEAN,           -- 是否启用
    priority INT,                 -- 优先级
    update_time TIMESTAMP         -- 更新时间
);
```

### **2. 热部署机制**

#### **实现原理**
- **广播状态**: 使用Flink的Broadcast State传播配置更新
- **处理器缓存**: 动态加载和缓存事件处理器实例
- **配置监听**: 定时检查数据库配置变更

#### **技术实现**
```java
// 核心组件
DynamicRoutingConfigSource      // 配置源，监听数据库变更
DynamicRoutingProcessFunction   // 动态路由处理函数
OutputRoutingProcessFunction    // 输出路由函数
```

### **3. 故障隔离**

#### **隔离级别**
- **处理器级别**: 单个事件类型处理失败不影响其他类型
- **输出级别**: 支持多输出目标，单个输出失败不影响其他输出
- **死信队列**: 处理失败的事件进入死信队列，避免阻塞

#### **容错机制**
- 异常捕获和日志记录
- 自动重试机制
- 监控指标和告警

## 🏗️ **新架构组件**

### **1. 核心配置组件**

| 组件 | 功能 | 位置 |
|------|------|------|
| `RoutingConfig` | 路由配置模型 | `config/RoutingConfig.java` |
| `ProcessedEvent` | 处理结果模型 | `bean/ProcessedEvent.java` |
| `RoutingConfigManager` | 配置管理工具 | `config/RoutingConfigManager.java` |

### **2. 动态路由组件**

| 组件 | 功能 | 位置 |
|------|------|------|
| `DynamicRoutingConfigSource` | 配置数据源 | `source/DynamicRoutingConfigSource.java` |
| `DynamicRoutingProcessFunction` | 动态路由处理 | `function/DynamicRoutingProcessFunction.java` |
| `OutputRoutingProcessFunction` | 输出路由 | `function/OutputRoutingProcessFunction.java` |

### **3. 输出组件**

| 组件 | 功能 | 位置 |
|------|------|------|
| `AliyunKafkaProducer` | Kafka生产者 | `sink/AliyunKafkaProducer.java` |
| `DynamicRoutingFlinkApp` | 主应用程序 | `app/DynamicRoutingFlinkApp.java` |

## 📊 **架构对比**

### **原架构 vs 新架构**

| 方面 | 原架构 | 新架构 |
|------|--------|--------|
| **事件路由** | 硬编码 | 数据库配置 |
| **新增事件类型** | 修改代码+重启 | 插入配置+30秒生效 |
| **故障隔离** | 单点故障影响全局 | 处理器级别隔离 |
| **输出目标** | 单一输出 | 多输出支持（主流+侧流） |
| **运维复杂度** | 高 | 低 |
| **可扩展性** | 弱 | 强 |

### **数据流向对比**

#### **原架构流向**
```
Kafka → EventProcessor → MySQL宽表
```

#### **新架构流向**
```
Kafka → DynamicRouting → ProcessedEvent → OutputRouting
                                              ├── 主流: MySQL宽表
                                              ├── 侧流: 告警Topic
                                              ├── 侧流: 指标Topic
                                              └── 侧流: 审计Topic
```

## 🛠️ **使用指南**

### **1. 启动动态路由作业**

```bash
# 启动错题本域作业
java -jar flink-app.jar wrongbook

# 启动用户域作业  
java -jar flink-app.jar user
```

### **2. 管理路由配置**

```bash
# 创建配置表
java -cp flink-app.jar com.flink.realtime.config.RoutingConfigManager create-table

# 添加路由配置
java -cp flink-app.jar com.flink.realtime.config.RoutingConfigManager \
  add wrongbook wrongbook_add com.flink.realtime.processor.impl.WrongbookAddProcessor

# 查看配置
java -cp flink-app.jar com.flink.realtime.config.RoutingConfigManager list wrongbook

# 禁用配置
java -cp flink-app.jar com.flink.realtime.config.RoutingConfigManager disable wrongbook wrongbook_add
```

### **3. 热更新配置**

```sql
-- 添加新的事件类型处理（30秒内生效）
INSERT INTO flink_routing_config (domain, event_type, processor_class, output_config) 
VALUES ('wrongbook', 'wrongbook_review', 
        'com.flink.realtime.processor.impl.WrongbookReviewProcessor',
        '{"sinks": ["wrongbook_wide_table", "metrics_topic"]}');

-- 修改输出配置（30秒内生效）
UPDATE flink_routing_config 
SET output_config = '{"sinks": ["wrongbook_wide_table", "alert_topic", "audit_topic"]}'
WHERE domain = 'wrongbook' AND event_type = 'wrongbook_add';
```

## 📈 **性能优化**

### **1. 处理器缓存**
- 智能缓存处理器实例，避免重复创建
- 配置更新时自动清理缓存

### **2. 批量处理**
- 支持批量写入MySQL，提高吞吐量
- 可配置批大小和刷新间隔

### **3. 阿里云优化**
- 针对阿里云Flink的专项优化
- 包括网络、内存、状态管理等方面

## 🔍 **监控指标**

### **1. 业务指标**
- 事件处理成功率
- 各事件类型处理量
- 端到端处理延迟

### **2. 系统指标**
- 配置更新频率
- 处理器缓存命中率
- 死信队列消息数量

### **3. 告警规则**
- 处理失败率 > 5%
- 平均延迟 > 10秒
- 死信队列消息积压 > 100

## 🗂️ **错题本场景示例**

### **业务流程**
1. 学生做错题 → 发送 `wrongbook_add` 事件
2. 学生订正错题 → 发送 `wrongbook_fix` 事件  
3. 学生删除错题 → 发送 `wrongbook_delete` 事件

### **处理器实现**
- `WrongbookAddProcessor`: 处理错题添加逻辑
- `WrongbookFixProcessor`: 处理错题订正逻辑
- `WrongbookDeleteProcessor`: 处理错题删除逻辑

### **输出路由**
- 主流: 写入 `wrongbook_wide_table`
- 告警流: 错题频率异常告警
- 指标流: 学习效果统计
- 审计流: 操作审计记录

## 🔄 **迁移指南**

### **1. 数据库准备**
```bash
# 执行初始化脚本
mysql -u root -p < sql/init_dynamic_routing.sql
```

### **2. 配置迁移**
- 将原有的硬编码处理逻辑迁移到数据库配置
- 添加相应的处理器实现

### **3. 验证测试**
- 验证配置热更新功能
- 测试故障隔离机制
- 检查监控指标正常

## 📚 **扩展开发**

### **1. 新增事件类型**
1. 实现 `EventProcessor` 接口
2. 在数据库中添加路由配置
3. 30秒内自动生效

### **2. 新增输出目标**
1. 实现相应的Sink函数
2. 在 `OutputRoutingProcessFunction` 中添加路由逻辑
3. 更新配置的 `output_config`

### **3. 自定义监控指标**
1. 继承 `AliyunMetricsReporter`
2. 添加自定义指标采集
3. 配置告警规则

## 🎉 **总结**

混合架构升级带来的核心价值：

- ✅ **开发效率提升**: 新增事件类型从天级变为分钟级
- ✅ **运维成本降低**: 配置变更无需重启，减少运维风险
- ✅ **系统稳定性增强**: 故障隔离机制，单点故障不影响全局
- ✅ **扩展能力增强**: 支持多输出、优先级配置等高级特性
- ✅ **监控能力完善**: 丰富的监控指标和告警机制

这个升级为项目的长期发展奠定了坚实的技术基础！
