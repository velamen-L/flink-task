# Flinkå®æ—¶è®¡ç®—å¼€å‘è§„èŒƒ

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº†åŸºäºAIç¼–ç¨‹è„šæ‰‹æ¶å’ŒåŠ¨æ€è·¯ç”±æ¶æ„çš„Flinkå®æ—¶è®¡ç®—å¼€å‘è§„èŒƒï¼Œç¡®ä¿ä»£ç è´¨é‡ã€æ¶æ„ä¸€è‡´æ€§å’Œå¼€å‘æ•ˆç‡ã€‚

## ğŸ“ é¡¹ç›®ç»“æ„è§„èŒƒ

### ç›®å½•ç»“æ„
```
flink-task/
â”œâ”€â”€ src/main/java/com/flink/realtime/
â”‚   â”œâ”€â”€ business/                           # ä¸šåŠ¡åº”ç”¨ç›®å½• â­
â”‚   â”‚   â””â”€â”€ {Domain}WideTableApp.java      # ä¸šåŠ¡åº”ç”¨ç±»
â”‚   â”œâ”€â”€ bean/                               # å®ä½“ç±»
â”‚   â”‚   â”œâ”€â”€ BusinessEvent.java             # ä¸šåŠ¡äº‹ä»¶å®ä½“
â”‚   â”‚   â””â”€â”€ ProcessedEvent.java            # å¤„ç†åäº‹ä»¶å®ä½“
â”‚   â”œâ”€â”€ config/                             # é…ç½®ç±»
â”‚   â”‚   â””â”€â”€ RoutingConfig.java             # è·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ common/                             # é€šç”¨å·¥å…·
â”‚   â”‚   â””â”€â”€ AliyunFlinkUtils.java          # é˜¿é‡Œäº‘Flinkå·¥å…·
â”‚   â”œâ”€â”€ function/                           # å‡½æ•°ç±»
â”‚   â”‚   â”œâ”€â”€ BusinessEventDeserializationSchema.java
â”‚   â”‚   â”œâ”€â”€ DynamicRoutingProcessFunction.java
â”‚   â”‚   â””â”€â”€ OutputRoutingProcessFunction.java
â”‚   â”œâ”€â”€ processor/                          # å¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ impl/                          # å¤„ç†å™¨å®ç°
â”‚   â”œâ”€â”€ sink/                               # è¾“å‡ºç±»
â”‚   â”‚   â””â”€â”€ AliyunMySQLSinkFunction.java   # MySQLè¾“å‡º
â”‚   â”œâ”€â”€ source/                             # æ•°æ®æº
â”‚   â”‚   â”œâ”€â”€ AliyunKafkaSourceBuilder.java  # Kafkaæºæ„å»ºå™¨
â”‚   â”‚   â””â”€â”€ DynamicRoutingConfigSource.java # åŠ¨æ€è·¯ç”±é…ç½®æº
â”‚   â””â”€â”€ util/                               # å·¥å…·ç±»
â”‚       â””â”€â”€ ConfigUtils.java               # é…ç½®å·¥å…·
â”œâ”€â”€ sql/                                    # SQLæ–‡ä»¶
â”œâ”€â”€ scripts/                                # è„šæœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ ai-job-generator.py               # AIä½œä¸šç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ test-ai-generator.py              # æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ examples/                          # é…ç½®ç¤ºä¾‹
â”‚   â””â”€â”€ templates/                         # æ¨¡æ¿æ–‡ä»¶
â””â”€â”€ docs/                                   # æ–‡æ¡£
```

### å‘½åè§„èŒƒ

#### 1. åŒ…å‘½å
- **ä¸šåŠ¡åº”ç”¨**: `com.flink.realtime.business`
- **å®ä½“ç±»**: `com.flink.realtime.bean`
- **é…ç½®ç±»**: `com.flink.realtime.config`
- **å‡½æ•°ç±»**: `com.flink.realtime.function`
- **å¤„ç†å™¨**: `com.flink.realtime.processor`
- **æ•°æ®æº**: `com.flink.realtime.source`
- **è¾“å‡ºç±»**: `com.flink.realtime.sink`
- **å·¥å…·ç±»**: `com.flink.realtime.util`

#### 2. ç±»å‘½å
- **ä¸šåŠ¡åº”ç”¨**: `{Domain}WideTableApp` (å¦‚: `WrongbookWideTableApp`)
- **å®ä½“ç±»**: ä»¥å®ä½“åå‘½å (å¦‚: `BusinessEvent`, `ProcessedEvent`)
- **å‡½æ•°ç±»**: ä»¥åŠŸèƒ½+Functionå‘½å (å¦‚: `DynamicRoutingProcessFunction`)
- **å¤„ç†å™¨**: ä»¥ä¸šåŠ¡+Processorå‘½å (å¦‚: `WrongbookAddProcessor`)
- **å·¥å…·ç±»**: ä»¥åŠŸèƒ½+Utilså‘½å (å¦‚: `ConfigUtils`)

#### 3. æ–¹æ³•å‘½å
- **ä¸»è¦æ–¹æ³•**: ä½¿ç”¨åŠ¨è¯+åè¯ (å¦‚: `processEvent`, `buildKafkaSource`)
- **é…ç½®æ–¹æ³•**: ä½¿ç”¨get+é…ç½®å (å¦‚: `getInsertSQL`, `getParameterSetter`)
- **å·¥å…·æ–¹æ³•**: ä½¿ç”¨åŠ¨è¯+åŠŸèƒ½ (å¦‚: `extractFromPayload`, `getSubjectName`)

## ğŸ”§ ä»£ç å¼€å‘è§„èŒƒ

### 1. ä¸šåŠ¡åº”ç”¨å¼€å‘

#### åŸºæœ¬ç»“æ„
```java
package com.flink.realtime.business;

import com.flink.realtime.bean.BusinessEvent;
import com.flink.realtime.bean.ProcessedEvent;
import com.flink.realtime.config.RoutingConfig;
// ... å…¶ä»–å¯¼å…¥

/**
 * {ä¸šåŠ¡åç§°}å®æ—¶å®½è¡¨ - AIç”Ÿæˆ
 * ä¸šåŠ¡åŸŸ: {domain}
 * ç”Ÿæˆæ—¶é—´: {timestamp}
 * 
 * æ”¯æŒçš„äº‹ä»¶ç±»å‹:
 * - {event_type}: {description}
 * 
 * @author AIä»£ç ç”Ÿæˆå™¨
 */
public class {Domain}WideTableApp {
    
    private static final Logger logger = LoggerFactory.getLogger({Domain}WideTableApp.class);
    
    public static void main(String[] args) throws Exception {
        // 1. åˆ›å»ºæ‰§è¡Œç¯å¢ƒ
        // 2. åˆ›å»ºäº‹ä»¶æº
        // 3. åˆ›å»ºåŠ¨æ€è·¯ç”±é…ç½®æº
        // 4. åŠ¨æ€è·¯ç”±å¤„ç†
        // 5. è¾“å‡ºè·¯ç”±
        // 6. è¾“å‡ºåˆ°å®½è¡¨
        // 7. æ‰§è¡Œä½œä¸š
    }
    
    // ç§æœ‰æ–¹æ³•å®šä¹‰
}
```

#### å¿…éœ€æ­¥éª¤
1. **æ‰§è¡Œç¯å¢ƒåˆ›å»º**: ä½¿ç”¨`AliyunFlinkUtils.getAliyunStreamExecutionEnvironment()`
2. **äº‹ä»¶æºåˆ›å»º**: ä½¿ç”¨`AliyunKafkaSourceBuilder.buildAliyunKafkaSource()`
3. **åŠ¨æ€è·¯ç”±é…ç½®**: ä½¿ç”¨`DynamicRoutingConfigSource`
4. **äº‹ä»¶å¤„ç†**: ä½¿ç”¨`DynamicRoutingProcessFunction`
5. **è¾“å‡ºè·¯ç”±**: ä½¿ç”¨`OutputRoutingProcessFunction`
6. **æ•°æ®è¾“å‡º**: ä½¿ç”¨`AliyunMySQLSinkFunction`

### 2. é…ç½®æ–‡ä»¶è§„èŒƒ

#### é…ç½®æ–‡ä»¶ç»“æ„
```json
{
  "domain": "ä¸šåŠ¡åŸŸå",
  "job_name": "ä½œä¸šåç§°",
  "description": "ä½œä¸šæè¿°",
  "source_table": {
    "name": "æºè¡¨å",
    "type": "kafka",
    "topic": "topicåç§°",
    "format": "json"
  },
  "result_table": {
    "name": "ç»“æœè¡¨å",
    "type": "mysql",
    "database": "æ•°æ®åº“å",
    "table": "è¡¨å"
  },
  "event_types": [
    {
      "type": "äº‹ä»¶ç±»å‹",
      "description": "äº‹ä»¶æè¿°",
      "payload_fields": [
        {
          "name": "å­—æ®µå",
          "type": "å­—æ®µç±»å‹",
          "required": true,
          "description": "å­—æ®µæè¿°"
        }
      ],
      "processing_logic": "å¤„ç†é€»è¾‘",
      "output_fields": ["è¾“å‡ºå­—æ®µåˆ—è¡¨"]
    }
  ],
  "dimension_tables": [
    {
      "name": "ç»´è¡¨å",
      "type": "mysql",
      "key_field": "ä¸»é”®å­—æ®µ",
      "query_sql": "æŸ¥è¯¢SQL",
      "refresh_interval": "åˆ·æ–°é—´éš”",
      "description": "ç»´è¡¨æè¿°"
    }
  ],
  "routing_config": {
    "enable_dynamic_routing": true,
    "config_source": "mysql",
    "config_table": "é…ç½®è¡¨å",
    "refresh_interval": "30s",
    "enable_hot_deployment": true,
    "enable_version_control": true
  }
}
```

### 3. äº‹ä»¶å¤„ç†è§„èŒƒ

#### äº‹ä»¶æ ¼å¼
```json
{
  "domain": "ä¸šåŠ¡åŸŸ",
  "type": "äº‹ä»¶ç±»å‹",
  "timestamp": 1640995200000,
  "eventId": "äº‹ä»¶ID",
  "payload": {
    "å­—æ®µ1": "å€¼1",
    "å­—æ®µ2": "å€¼2"
  }
}
```

#### å¤„ç†å™¨å¼€å‘
```java
public class {Domain}{EventType}Processor implements EventProcessor {
    
    @Override
    public Object process(BusinessEvent event) throws Exception {
        // 1. éªŒè¯äº‹ä»¶
        validateEvent(event);
        
        // 2. æå–æ•°æ®
        Map<String, Object> data = extractData(event);
        
        // 3. ä¸šåŠ¡å¤„ç†
        processBusinessLogic(data);
        
        // 4. è¿”å›ç»“æœ
        return data;
    }
    
    private void validateEvent(BusinessEvent event) {
        // äº‹ä»¶éªŒè¯é€»è¾‘
    }
    
    private Map<String, Object> extractData(BusinessEvent event) {
        // æ•°æ®æå–é€»è¾‘
    }
    
    private void processBusinessLogic(Map<String, Object> data) {
        // ä¸šåŠ¡å¤„ç†é€»è¾‘
    }
}
```

## ğŸš€ å¼€å‘å·¥ä½œæµ

### 1. æ–°ä¸šåŠ¡å¼€å‘æµç¨‹

#### æ­¥éª¤1: å®šä¹‰é…ç½®
```bash
# å¤åˆ¶é…ç½®æ¨¡æ¿
cp scripts/examples/wrongbook-wide-table-config.json scripts/examples/{domain}-wide-table-config.json

# ä¿®æ”¹é…ç½®æ–‡ä»¶
# - æ›´æ–°domain
# - å®šä¹‰event_types
# - é…ç½®dimension_tables
# - è®¾ç½®routing_config
```

#### æ­¥éª¤2: ç”Ÿæˆä»£ç 
```bash
# ä½¿ç”¨AIç”Ÿæˆå™¨
python scripts/ai-job-generator.py scripts/examples/{domain}-wide-table-config.json

# ç”Ÿæˆçš„Javaæ–‡ä»¶ä½ç½®
src/main/java/com/flink/realtime/business/{Domain}WideTableApp.java
```

#### æ­¥éª¤3: å¼€å‘å¤„ç†å™¨
```bash
# åˆ›å»ºå¤„ç†å™¨ç±»
src/main/java/com/flink/realtime/processor/impl/{Domain}{EventType}Processor.java
```

#### æ­¥éª¤4: æµ‹è¯•éªŒè¯
```bash
# è¿è¡Œæµ‹è¯•
python scripts/test-ai-generator.py

# æœ¬åœ°æµ‹è¯•
mvn test
```

#### æ­¥éª¤5: éƒ¨ç½²è¿è¡Œ
```bash
# ç¼–è¯‘æ‰“åŒ…
mvn clean package -DskipTests

# æäº¤ä½œä¸š
$FLINK_HOME/bin/flink run \
  --class com.flink.realtime.business.{Domain}WideTableApp \
  target/flink-task-1.0-SNAPSHOT.jar {domain}
```

### 2. ç°æœ‰ä¸šåŠ¡ç»´æŠ¤æµç¨‹

#### æ·»åŠ æ–°äº‹ä»¶ç±»å‹
1. **æ›´æ–°é…ç½®æ–‡ä»¶**: åœ¨`event_types`ä¸­æ·»åŠ æ–°äº‹ä»¶ç±»å‹
2. **å¼€å‘å¤„ç†å™¨**: åˆ›å»ºå¯¹åº”çš„å¤„ç†å™¨ç±»
3. **çƒ­éƒ¨ç½²**: é€šè¿‡é…ç½®æºæ›´æ–°è·¯ç”±é…ç½®
4. **ç›‘æ§éªŒè¯**: æ£€æŸ¥æ–°äº‹ä»¶ç±»å‹çš„å¤„ç†æƒ…å†µ

#### ä¿®æ”¹ä¸šåŠ¡é€»è¾‘
1. **æ›´æ–°å¤„ç†å™¨**: ä¿®æ”¹å¯¹åº”çš„å¤„ç†å™¨ç±»
2. **é‡æ–°éƒ¨ç½²**: é‡æ–°ç¼–è¯‘å’Œéƒ¨ç½²ä½œä¸š
3. **éªŒè¯åŠŸèƒ½**: æµ‹è¯•ä¿®æ”¹åçš„åŠŸèƒ½

## ğŸ“Š ä»£ç è´¨é‡è§„èŒƒ

### 1. ä»£ç é£æ ¼

#### æ³¨é‡Šè§„èŒƒ
- **ç±»æ³¨é‡Š**: åŒ…å«åŠŸèƒ½æè¿°ã€ä½œè€…ã€æ—¶é—´
- **æ–¹æ³•æ³¨é‡Š**: åŒ…å«å‚æ•°è¯´æ˜ã€è¿”å›å€¼ã€å¼‚å¸¸
- **å…³é”®é€»è¾‘æ³¨é‡Š**: å¤æ‚ä¸šåŠ¡é€»è¾‘å¿…é¡»æœ‰æ³¨é‡Š

#### å¼‚å¸¸å¤„ç†
```java
try {
    // ä¸šåŠ¡é€»è¾‘
} catch (Exception e) {
    logger.error("å¤„ç†äº‹ä»¶å¤±è´¥: {}", event, e);
    // é”™è¯¯å¤„ç†é€»è¾‘
    out.collect(event); // ç»§ç»­å¤„ç†ï¼Œé¿å…æ•°æ®ä¸¢å¤±
}
```

#### æ—¥å¿—è§„èŒƒ
```java
// ä½¿ç”¨å ä½ç¬¦ï¼Œé¿å…å­—ç¬¦ä¸²æ‹¼æ¥
logger.info("å¯åŠ¨{}å®½è¡¨ä½œä¸šï¼Œä¸šåŠ¡åŸŸ: {}", jobName, domain);
logger.error("å¤„ç†äº‹ä»¶å¤±è´¥: {}", event, e);
logger.debug("æ›´æ–°ç»´è¡¨æ•°æ®: {}", key);
```

### 2. æ€§èƒ½ä¼˜åŒ–

#### çŠ¶æ€ç®¡ç†
- ä½¿ç”¨`BroadcastState`è¿›è¡Œé…ç½®ç®¡ç†
- åˆç†è®¾ç½®çŠ¶æ€TTLï¼Œé¿å…å†…å­˜æ³„æ¼
- ä½¿ç”¨`MapState`è¿›è¡Œç»´è¡¨ç¼“å­˜

#### å¹¶è¡Œåº¦é…ç½®
- æ ¹æ®æ•°æ®é‡åˆç†è®¾ç½®å¹¶è¡Œåº¦
- ä½¿ç”¨`ConfigUtils.getInt("flink.parallelism", 2)`
- ç›‘æ§ä½œä¸šæ€§èƒ½ï¼ŒåŠ¨æ€è°ƒæ•´

#### æ‰¹å¤„ç†ä¼˜åŒ–
- ä½¿ç”¨æ‰¹é‡è¾“å‡ºå‡å°‘ç½‘ç»œå¼€é”€
- åˆç†è®¾ç½®æ‰¹å¤§å°ï¼š`AliyunMySQLSinkFunction<>(sql, setter, 100)`
- ç›‘æ§æ‰¹å¤„ç†å»¶è¿Ÿ

### 3. ç›‘æ§è§„èŒƒ

#### å…³é”®æŒ‡æ ‡
- **äº‹ä»¶å¤„ç†é€Ÿç‡**: æ¯ç§’å¤„ç†äº‹ä»¶æ•°
- **å¤„ç†å»¶è¿Ÿ**: äº‹ä»¶ä»æ¥æ”¶åˆ°å¤„ç†çš„æ—¶é—´
- **é”™è¯¯ç‡**: å¤„ç†å¤±è´¥çš„äº‹ä»¶æ¯”ä¾‹
- **çŠ¶æ€å¤§å°**: å†…å­˜ä¸­çŠ¶æ€æ•°æ®å¤§å°

#### å‘Šè­¦è§„åˆ™
- **å¤„ç†å»¶è¿Ÿ > 30ç§’**: ç«‹å³å‘Šè­¦
- **é”™è¯¯ç‡ > 1%**: å‘Šè­¦å¹¶æ£€æŸ¥
- **çŠ¶æ€å¤§å°å¼‚å¸¸**: æ£€æŸ¥å†…å­˜ä½¿ç”¨

## ğŸ”„ ç‰ˆæœ¬æ§åˆ¶è§„èŒƒ

### 1. åˆ†æ”¯ç®¡ç†
- **main**: ä¸»åˆ†æ”¯ï¼Œç¨³å®šç‰ˆæœ¬
- **develop**: å¼€å‘åˆ†æ”¯ï¼Œé›†æˆæµ‹è¯•
- **feature/xxx**: åŠŸèƒ½åˆ†æ”¯ï¼Œæ–°åŠŸèƒ½å¼€å‘
- **hotfix/xxx**: çƒ­ä¿®å¤åˆ†æ”¯ï¼Œç´§æ€¥ä¿®å¤

### 2. æäº¤è§„èŒƒ
```
feat: æ·»åŠ æ–°åŠŸèƒ½
fix: ä¿®å¤bug
docs: æ›´æ–°æ–‡æ¡£
style: ä»£ç æ ¼å¼è°ƒæ•´
refactor: ä»£ç é‡æ„
test: æ·»åŠ æµ‹è¯•
chore: æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨
```

### 3. ç‰ˆæœ¬å·è§„èŒƒ
- **ä¸»ç‰ˆæœ¬å·**: ä¸å…¼å®¹çš„APIä¿®æ”¹
- **æ¬¡ç‰ˆæœ¬å·**: å‘ä¸‹å…¼å®¹çš„åŠŸèƒ½æ€§æ–°å¢
- **ä¿®è®¢å·**: å‘ä¸‹å…¼å®¹çš„é—®é¢˜ä¿®æ­£

## ğŸ‰ æ€»ç»“

æœ¬å¼€å‘è§„èŒƒç¡®ä¿äº†ï¼š

1. **æ¶æ„ä¸€è‡´æ€§**: æ‰€æœ‰ä¸šåŠ¡åº”ç”¨éµå¾ªç›¸åŒçš„æ¶æ„æ¨¡å¼
2. **ä»£ç è´¨é‡**: ç»Ÿä¸€çš„ä»£ç é£æ ¼å’Œæœ€ä½³å®è·µ
3. **å¼€å‘æ•ˆç‡**: æ ‡å‡†åŒ–çš„å¼€å‘æµç¨‹å’Œå·¥å…·
4. **ç»´æŠ¤æ€§**: æ¸…æ™°çš„æ–‡æ¡£å’Œç‰ˆæœ¬æ§åˆ¶
5. **å¯æ‰©å±•æ€§**: æ”¯æŒæ–°ä¸šåŠ¡å¿«é€Ÿæ¥å…¥

éµå¾ªæœ¬è§„èŒƒï¼Œå¯ä»¥ç¡®ä¿é¡¹ç›®çš„é•¿æœŸç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
