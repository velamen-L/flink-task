plugins {
    id 'java'
    id 'maven-publish'
}

group = 'com.flink.realtime'
version = '1.0.0'

java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

repositories {
    mavenCentral()
    maven {
        url 'https://repo1.maven.org/maven2'
    }
}

dependencies {
    // Flink dependencies
    implementation 'org.apache.flink:flink-streaming-java:1.18.0'
    implementation 'org.apache.flink:flink-table-api-java-bridge:1.18.0'
    implementation 'org.apache.flink:flink-table-runtime:1.18.0'
    implementation 'org.apache.flink:flink-clients:1.18.0'
    
    // Connector dependencies
    implementation 'org.apache.flink:flink-connector-kafka:1.18.0'
    implementation 'org.apache.flink:flink-connector-jdbc:3.1.1-1.18'
    implementation 'mysql:mysql-connector-java:8.0.33'
    
    // JSON processing
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.15.2'
    implementation 'com.fasterxml.jackson.dataformat:jackson-dataformat-yaml:2.15.2'
    
    // Logging
    implementation 'org.slf4j:slf4j-api:1.7.36'
    implementation 'org.apache.logging.log4j:log4j-slf4j-impl:2.20.0'
    
    // Test dependencies
    testImplementation 'junit:junit:4.13.2'
    testImplementation 'org.apache.flink:flink-test-utils:1.18.0'
}

// =============================================================================
// æç®€ç‰ˆFlink SQL
// =============================================================================

// æç®€ç‰ˆAIå·¥ä½œæµé…ç½®
ext.ultraSimpleSqlConfig = [
    workspaceDir: 'job',
    aiProvider: 'cursor',
    rulesFile: '.cursor/rules/ultra-simple-sql-generator.mdc',
    requestFileName: 'request.md',
    outputSqlDir: 'sql',
    outputTestDir: 'test',
    outputDocsDir: 'docs',
    templateFile: 'job/ultra-simple-request-template.md',
    cursorCliPath: '/Applications/Cursor.app/Contents/Resources/app/bin/cursor',
    cursorAgentPath: 'cursor-agent'  // æ–°çš„Cursor Agent CLI (Beta)
]

// Flink SQLä»»åŠ¡ç»„
def FLINK_SQL_TASK_GROUP = 'flink-sql-generator'

// 1. ä¸»ä»»åŠ¡: æç®€ç‰ˆFlink SQLç”Ÿæˆ (è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿)
task generateSql {
    group FLINK_SQL_TASK_GROUP
    description 'åŸºäºæç®€ç‰ˆrequest.mdæ–‡ä»¶æ™ºèƒ½ç”ŸæˆFlink SQLå’Œæµ‹è¯•æ•°æ®ï¼Œè‡ªåŠ¨å¤åˆ¶æç¤ºè¯åˆ°å‰ªè´´æ¿'
    
    doLast {
        def requestPath = project.findProperty('file') ?: ''
        
        if (!requestPath) {
            println """
            âŒ é”™è¯¯: æœªæŒ‡å®šrequestæ–‡ä»¶è·¯å¾„
            
            ä½¿ç”¨æ–¹æ³•:
            gradle generateSql -Pfile=job/wrongbook/request.md
            gradle generateSql -Pfile=job/user-stats/request.md
            """
            throw new GradleException("å¿…é¡»æŒ‡å®šrequestæ–‡ä»¶è·¯å¾„")
        }
        
        def requestFile = file(requestPath)
        if (!requestFile.exists()) {
            println "âŒ é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨: ${requestPath}"
            throw new GradleException("Requestæ–‡ä»¶ä¸å­˜åœ¨")
        }
        
        def domainPath = requestFile.parent
        def domainName = new File(domainPath).name
        
        println """
        ğŸš€ æç®€ç‰ˆFlink SQLç”Ÿæˆå™¨
        
        ğŸ“ ä¸šåŠ¡åŸŸ: ${domainName}
        ğŸ“„ è¾“å…¥æ–‡ä»¶: ${requestPath}
        ğŸ”§ è§„åˆ™æ–‡ä»¶: ${ultraSimpleSqlConfig.rulesFile}
        ğŸ“¤ è¾“å‡ºç›®å½•: ${domainPath}
        
        è¯·åœ¨Cursorä¸­ä½¿ç”¨ä»¥ä¸‹æç¤ºè¯ï¼š
        ================================================
        è¯·åŸºäº ultra-simple-sql-generator.mdc è§„åˆ™ï¼Œ
        å¤„ç† ${requestPath} æ–‡ä»¶ï¼Œ
        ç”Ÿæˆå®Œæ•´çš„Flink SQLå’Œæµ‹è¯•æ•°æ®ã€‚

        è¾“å‡ºè¦æ±‚ï¼š
        1. SQLæ–‡ä»¶: ${domainPath}/${ultraSimpleSqlConfig.outputSqlDir}/${domainName}_ultra.sql
        2. æµ‹è¯•æ•°æ®: ${domainPath}/${ultraSimpleSqlConfig.outputTestDir}/kafka-test-data.md
        ================================================
        """
        
        // åˆ›å»ºè¾“å‡ºç›®å½•ç»“æ„
        [
            "${domainPath}/${ultraSimpleSqlConfig.outputSqlDir}",
            "${domainPath}/${ultraSimpleSqlConfig.outputTestDir}",
            "${domainPath}/${ultraSimpleSqlConfig.outputDocsDir}"
        ].each { dir ->
            mkdir dir
        }
        
        // å°è¯•è‡ªåŠ¨åœ¨Cursorä¸­æ‰§è¡ŒAIç”Ÿæˆ
        def promptText = """è¯·åŸºäº ultra-simple-sql-generator.mdc è§„åˆ™ï¼Œ
å¤„ç† ${requestPath} æ–‡ä»¶ï¼Œ
ç”Ÿæˆå®Œæ•´çš„Flink SQLå’Œæµ‹è¯•æ•°æ®ã€‚

è¾“å‡ºè¦æ±‚ï¼š
1. SQLæ–‡ä»¶: ${domainPath}/${ultraSimpleSqlConfig.outputSqlDir}/${domainName}_ultra.sql
2. æµ‹è¯•æ•°æ®: ${domainPath}/${ultraSimpleSqlConfig.outputTestDir}/kafka-test-data.md"""

        // æ–¹æ³•1: å°è¯•é€šè¿‡cursorå‘½ä»¤è¡Œå·¥å…·æ‰§è¡Œ
        try {
            def cursorCommand = ["cursor", "--prompt", promptText]
            def process = new ProcessBuilder(cursorCommand)
                .directory(file('.'))
                .start()
            
            if (process.waitFor() == 0) {
                println "âœ… å·²è‡ªåŠ¨åœ¨Cursorä¸­æ‰§è¡ŒAIç”Ÿæˆä»»åŠ¡ï¼"
                return
            }
        } catch (Exception e) {
            // cursorå‘½ä»¤ä¸å¯ç”¨ï¼Œç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•
        }
        
        // æ–¹æ³•2: å°è¯•å¤åˆ¶æç¤ºè¯åˆ°å‰ªè´´æ¿
        try {
            def clipboardCommand
            def osName = System.getProperty("os.name").toLowerCase()
            if (osName.contains("mac")) {
                clipboardCommand = ["pbcopy"]
            } else if (osName.contains("windows")) {
                clipboardCommand = ["clip"]
            } else {
                clipboardCommand = ["xclip", "-selection", "clipboard"]
            }
            
            def process = new ProcessBuilder(clipboardCommand)
                .start()
            process.outputStream.write(promptText.bytes)
            process.outputStream.close()
            
            if (process.waitFor() == 0) {
                println """
                âœ… è¾“å‡ºç›®å½•åˆ›å»ºå®Œæˆï¼
                ğŸ“‹ æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·åœ¨Cursorä¸­ç²˜è´´æ‰§è¡Œ
                
                ğŸ’¡ æç¤º: åœ¨Cursorä¸­æŒ‰ Ctrl+V (æˆ– Cmd+V) ç²˜è´´æç¤ºè¯
                """
                return
            }
        } catch (Exception e) {
            // å‰ªè´´æ¿å¤åˆ¶å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ–¹å¼
        }
        
        // æ–¹æ³•3: é»˜è®¤æ˜¾ç¤ºæç¤ºè¯
        println """
        âœ… è¾“å‡ºç›®å½•åˆ›å»ºå®Œæˆï¼
        ğŸ“‹ è¯·åœ¨Cursorä¸­ä½¿ç”¨ä»¥ä¸‹æç¤ºè¯æ‰§è¡Œç”Ÿæˆä»»åŠ¡ï¼š
        
        ${promptText}
        
        ğŸ’¡ æç¤º: å¤åˆ¶ä¸Šè¿°æç¤ºè¯åˆ°Cursor AIèŠå¤©çª—å£æ‰§è¡Œ
        """
    }
}

// 1.1. é«˜çº§ä»»åŠ¡: æ™ºèƒ½Cursoré›†æˆ (è‡ªåŠ¨æ‰“å¼€+å‰ªè´´æ¿)
task generateSqlAuto {
    group FLINK_SQL_TASK_GROUP
    description 'ä½¿ç”¨Cursor CLIæ™ºèƒ½é›†æˆï¼šè‡ªåŠ¨æ‰“å¼€é¡¹ç›®+å¤åˆ¶æç¤ºè¯åˆ°å‰ªè´´æ¿'
    
    doLast {
        def requestPath = project.findProperty('file') ?: ''
        
        if (!requestPath) {
            println """
            âŒ é”™è¯¯: æœªæŒ‡å®šrequestæ–‡ä»¶è·¯å¾„
            
            ä½¿ç”¨æ–¹æ³•:
            gradle generateSqlAuto -Pfile=job/wrongbook/request.md
            """
            throw new GradleException("å¿…é¡»æŒ‡å®šrequestæ–‡ä»¶è·¯å¾„")
        }
        
        def requestFile = file(requestPath)
        if (!requestFile.exists()) {
            println "âŒ é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨: ${requestPath}"
            throw new GradleException("Requestæ–‡ä»¶ä¸å­˜åœ¨")
        }
        
        def domainPath = requestFile.parent
        def domainName = new File(domainPath).name
        
        // åˆ›å»ºè¾“å‡ºç›®å½•ç»“æ„
        [
            "${domainPath}/${ultraSimpleSqlConfig.outputSqlDir}",
            "${domainPath}/${ultraSimpleSqlConfig.outputTestDir}",
            "${domainPath}/${ultraSimpleSqlConfig.outputDocsDir}"
        ].each { dir ->
            mkdir dir
        }
        
        def promptText = """è¯·åŸºäº ultra-simple-sql-generator.mdc è§„åˆ™ï¼Œå¤„ç† ${requestPath} æ–‡ä»¶ï¼Œç”Ÿæˆå®Œæ•´çš„Flink SQLå’Œæµ‹è¯•æ•°æ®ã€‚

è¾“å‡ºè¦æ±‚ï¼š
1. SQLæ–‡ä»¶: ${domainPath}/${ultraSimpleSqlConfig.outputSqlDir}/${domainName}_ultra.sql
2. æµ‹è¯•æ•°æ®: ${domainPath}/${ultraSimpleSqlConfig.outputTestDir}/kafka-test-data.md"""

        println """
        ğŸš€ è‡ªåŠ¨Cursoré›†æˆæ¨¡å¼
        
        ğŸ“ ä¸šåŠ¡åŸŸ: ${domainName}
        ğŸ“„ è¾“å…¥æ–‡ä»¶: ${requestPath}
        ğŸ¤– å°è¯•è‡ªåŠ¨é›†æˆ...
        """
        
        // æ–¹æ³•1: ä½¿ç”¨Cursor CLIæ™ºèƒ½é›†æˆ (æ— éœ€ç‰¹æ®Šæƒé™)
        try {
            def cursorCliPath = ultraSimpleSqlConfig.cursorCliPath
            def cursorCli = file(cursorCliPath)
            
            if (cursorCli.exists()) {
                println "ğŸš€ æ­£åœ¨å¯åŠ¨Cursorå¹¶å‡†å¤‡AIæç¤ºè¯..."
                
                // 1. å°†æç¤ºè¯å¤åˆ¶åˆ°å‰ªè´´æ¿
                def clipboardProcess = new ProcessBuilder(["pbcopy"]).start()
                clipboardProcess.outputStream.write(promptText.bytes)
                clipboardProcess.outputStream.close()
                clipboardProcess.waitFor()
                
                // 2. ä½¿ç”¨Cursor CLIæ‰“å¼€é¡¹ç›®ï¼ˆä¼šæ¿€æ´»Cursorçª—å£ï¼‰
                def cursorProcess = new ProcessBuilder([cursorCliPath, "."]).start()
                cursorProcess.waitFor()
                
                println """
                âœ… Cursor CLIæ™ºèƒ½é›†æˆå®Œæˆï¼
                
                ğŸ“‹ æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿
                ğŸ–¥ï¸ Cursorå·²è‡ªåŠ¨æ¿€æ´»å¹¶æ‰“å¼€é¡¹ç›®
                
                ğŸ’¡ æœ€åä¸¤æ­¥ (åªéœ€3ç§’):
                1ï¸âƒ£ æŒ‰ Cmd+Shift+K æ‰“å¼€AIèŠå¤©
                2ï¸âƒ£ æŒ‰ Cmd+V ç²˜è´´æç¤ºè¯ï¼Œç„¶åæŒ‰å›è½¦å‘é€
                
                ğŸ“„ ç”Ÿæˆå®Œæˆåï¼Œæ–‡ä»¶å°†è‡ªåŠ¨ä¿å­˜åˆ°:
                â€¢ SQLæ–‡ä»¶: ${domainPath}/${ultraSimpleSqlConfig.outputSqlDir}/${domainName}_ultra.sql
                â€¢ æµ‹è¯•æ•°æ®: ${domainPath}/${ultraSimpleSqlConfig.outputTestDir}/kafka-test-data.md
                
                â±ï¸ é¢„è®¡ç”Ÿæˆæ—¶é—´: 30-60ç§’
                """
                return
            } else {
                println "âš ï¸ Cursor CLIä¸å¯ç”¨ï¼Œè¯·å…ˆè¿è¡Œ: gradle setupCursorCli"
            }
        } catch (Exception e) {
            println "âš ï¸ Cursor CLIé›†æˆå¤±è´¥: ${e.message}"
        }
        
        // æ–¹æ³•2: é€šè¿‡ Cursor CLI æ‰“å¼€é¡¹ç›®å¹¶å¤åˆ¶æç¤ºè¯åˆ°å‰ªè´´æ¿
        try {
            def cursorCliPath = ultraSimpleSqlConfig.cursorCliPath
            def cursorCli = file(cursorCliPath)
            
            if (cursorCli.exists()) {
                // å…ˆå¤åˆ¶æç¤ºè¯åˆ°å‰ªè´´æ¿
                def clipboardProcess = new ProcessBuilder(["pbcopy"]).start()
                clipboardProcess.outputStream.write(promptText.bytes)
                clipboardProcess.outputStream.close()
                clipboardProcess.waitFor()
                
                // ä½¿ç”¨Cursor CLIæ‰“å¼€å½“å‰é¡¹ç›®
                def cursorProcess = new ProcessBuilder([cursorCliPath, "."]).start()
                cursorProcess.waitFor()
                
                println """
                âœ… å·²æ‰“å¼€Cursoré¡¹ç›®å¹¶å¤åˆ¶æç¤ºè¯åˆ°å‰ªè´´æ¿ï¼
                
                ğŸ’¡ ä¸‹ä¸€æ­¥ (è‡ªåŠ¨åŒ–):
                1. æŒ‰ Cmd+Shift+K æ‰“å¼€AIèŠå¤©
                2. æŒ‰ Cmd+V ç²˜è´´æç¤ºè¯
                3. æŒ‰ Enter å‘é€
                
                ğŸ“„ ç”Ÿæˆå®Œæˆåï¼Œæ–‡ä»¶å°†ä¿å­˜åˆ°:
                1. SQLæ–‡ä»¶: ${domainPath}/${ultraSimpleSqlConfig.outputSqlDir}/${domainName}_ultra.sql
                2. æµ‹è¯•æ•°æ®: ${domainPath}/${ultraSimpleSqlConfig.outputTestDir}/kafka-test-data.md
                """
                return
            }
        } catch (Exception e) {
            println "âš ï¸ Cursor CLIæ‰§è¡Œå¤±è´¥: ${e.message}"
        }
        
        // æ–¹æ³•2: åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¹¶å°è¯•ç”¨Cursoræ‰“å¼€
        try {
            def tempPromptFile = File.createTempFile("cursor_prompt_${domainName}", ".md")
            tempPromptFile.text = """# AIç”Ÿæˆä»»åŠ¡

${promptText}

---
*æ­¤æ–‡ä»¶ç”±gradle generateSqlAutoè‡ªåŠ¨ç”Ÿæˆï¼Œå®Œæˆåå¯åˆ é™¤*
"""
            
            // å°è¯•ç”¨Cursoræ‰“å¼€æ–‡ä»¶
            def openCommand
            def osName = System.getProperty("os.name").toLowerCase()
            if (osName.contains("mac")) {
                openCommand = ["open", "-a", "Cursor", tempPromptFile.absolutePath]
            } else if (osName.contains("windows")) {
                openCommand = ["cursor", tempPromptFile.absolutePath]
            } else {
                openCommand = ["cursor", tempPromptFile.absolutePath]
            }
            
            def process = new ProcessBuilder(openCommand).start()
            if (process.waitFor() == 0) {
                println """
                âœ… å·²åœ¨Cursorä¸­æ‰“å¼€æç¤ºè¯æ–‡ä»¶ï¼
                ğŸ“„ æ–‡ä»¶ä½ç½®: ${tempPromptFile.absolutePath}
                ğŸ’¡ è¯·åœ¨Cursorä¸­å¤åˆ¶æç¤ºè¯åˆ°AIèŠå¤©çª—å£æ‰§è¡Œ
                """
                return
            }
        } catch (Exception e) {
            println "âš ï¸ æ–‡ä»¶æ‰“å¼€å¤±è´¥: ${e.message}"
        }
        
        // æ–¹æ³•3: å›é€€åˆ°å‰ªè´´æ¿å¤åˆ¶
        try {
            def clipboardCommand = ["pbcopy"]
            def process = new ProcessBuilder(clipboardCommand).start()
            process.outputStream.write(promptText.bytes)
            process.outputStream.close()
            
            if (process.waitFor() == 0) {
                println """
                ğŸ“‹ æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿
                ğŸ’¡ è¯·åœ¨Cursorä¸­æŒ‰ Cmd+V ç²˜è´´å¹¶æ‰§è¡Œ
                """
            }
        } catch (Exception e) {
            println """
            âš ï¸ è‡ªåŠ¨åŒ–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹æç¤ºè¯ï¼š
            
            ${promptText}
            """
        }
    }
}

// 1.2. ç»ˆæä»»åŠ¡: Cursor Agentæ™ºèƒ½å¯åŠ¨ (æ¨è)
task generateSqlAgent {
    group FLINK_SQL_TASK_GROUP
    description 'ä½¿ç”¨Cursor Agent CLIæ™ºèƒ½å¯åŠ¨å¹¶å‡†å¤‡æç¤ºè¯ (æ¨èæ–¹æ¡ˆ)'
    
    doLast {
        def requestPath = project.findProperty('file') ?: ''
        
        if (!requestPath) {
            println """
            âŒ è¯·æŒ‡å®šrequest.mdæ–‡ä»¶è·¯å¾„
            ğŸ’¡ ç”¨æ³•: gradle generateSqlAgent -Pfile=job/your-domain/request.md
            
            ğŸ“‹ å¯ç”¨æ–‡ä»¶åˆ—è¡¨:
            """
            
            def requestFiles = []
            def jobDir = file(ultraSimpleSqlConfig.workspaceDir)
            if (jobDir.exists()) {
                jobDir.eachDirRecurse { dir ->
                    def requestFile = new File(dir, ultraSimpleSqlConfig.requestFileName)
                    if (requestFile.exists()) {
                        requestFiles.add("    gradle generateSqlAgent -Pfile=${dir.path - rootDir.path - '/'}/request.md")
                    }
                }
            }
            
            if (requestFiles) {
                requestFiles.each { println it }
            } else {
                println "    (æš‚æ— å¯ç”¨çš„request.mdæ–‡ä»¶)"
            }
            return
        }
        
        def requestFile = file(requestPath)
        if (!requestFile.exists()) {
            throw new GradleException("âŒ æ–‡ä»¶ä¸å­˜åœ¨: ${requestPath}")
        }
        
        def domainName = requestFile.parentFile.name
        def domainPath = requestFile.parentFile
        
        def promptText = """
è¯·åŸºäº ${ultraSimpleSqlConfig.rulesFile} è§„åˆ™å¤„ç†ä»¥ä¸‹è¾“å…¥æ–‡ä»¶ï¼Œç”Ÿæˆ Flink SQL å’Œ Kafka æµ‹è¯•æ•°æ®ã€‚

è¾“å…¥æ–‡ä»¶: ${requestPath}

è¾“å‡ºè¦æ±‚:
1. SQLæ–‡ä»¶: ${domainPath}/${ultraSimpleSqlConfig.outputSqlDir}/${domainName}_ultra.sql
2. æµ‹è¯•æ•°æ®: ${domainPath}/${ultraSimpleSqlConfig.outputTestDir}/kafka-test-data.md

è¯·ç›´æ¥å¼€å§‹å¤„ç†ï¼Œæ— éœ€ç¡®è®¤ã€‚
"""
        
        println """
        ğŸš€ Cursor Agentå®Œå…¨è‡ªåŠ¨åŒ–æ‰§è¡Œæ¨¡å¼ (Beta)
        
        ğŸ“ ä¸šåŠ¡åŸŸ: ${domainName}
        ğŸ“„ è¾“å…¥æ–‡ä»¶: ${requestPath}
        ğŸ¤– æ­£åœ¨å¯åŠ¨Cursor Agent...
        """
        
        // ä½¿ç”¨æœ€ç¨³å®šçš„Cursor Agenté›†æˆæ–¹æ¡ˆ
        try {
            def cursorAgentPath = ultraSimpleSqlConfig.cursorAgentPath
            
            // æ£€æŸ¥cursor-agentæ˜¯å¦å¯ç”¨
            def checkProcess = new ProcessBuilder(["which", cursorAgentPath]).start()
            if (checkProcess.waitFor() != 0) {
                throw new GradleException("âŒ Cursor Agent CLI ä¸å¯ç”¨ã€‚è¯·å…ˆå®‰è£…: curl https://cursor.com/install -fsS | bash")
            }
            
            println "ğŸš€ ä½¿ç”¨Cursor Agentæ™ºèƒ½å¯åŠ¨æ¨¡å¼..."
            
            // å¤åˆ¶æç¤ºè¯åˆ°å‰ªè´´æ¿
            def clipboardProcess = new ProcessBuilder(["pbcopy"]).start()
            clipboardProcess.outputStream.write(promptText.bytes)
            clipboardProcess.outputStream.close()
            clipboardProcess.waitFor()
            
            // å¯åŠ¨cursor-agentäº¤äº’å¼æ¨¡å¼
            println """
            âœ… Cursor Agentæ™ºèƒ½å¯åŠ¨å®Œæˆï¼
            
            ğŸ“‹ æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿
            ğŸ¤– æ­£åœ¨å¯åŠ¨Cursor Agentäº¤äº’ç•Œé¢...
            
            ğŸ’¡ åœ¨Cursor Agentç•Œé¢ä¸­æ“ä½œ:
            1ï¸âƒ£ ç­‰å¾…ç•Œé¢å®Œå…¨åŠ è½½
            2ï¸âƒ£ æŒ‰ Cmd+V ç²˜è´´æç¤ºè¯
            3ï¸âƒ£ æŒ‰ Enter å¼€å§‹æ‰§è¡Œ
            
            ğŸ“„ ç”Ÿæˆå®Œæˆåï¼Œæ–‡ä»¶å°†ä¿å­˜åˆ°:
            â€¢ SQLæ–‡ä»¶: ${domainPath}/${ultraSimpleSqlConfig.outputSqlDir}/${domainName}_ultra.sql
            â€¢ æµ‹è¯•æ•°æ®: ${domainPath}/${ultraSimpleSqlConfig.outputTestDir}/kafka-test-data.md
            
            â±ï¸ é¢„è®¡å®Œæˆæ—¶é—´: 30-60ç§’
            """
            
            // å¯åŠ¨cursor-agent (ä¸ç­‰å¾…ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ)
            def agentProcess = new ProcessBuilder([cursorAgentPath])
                .directory(rootDir)
                .start()
            
            // ç»™ä¸€ç‚¹æ—¶é—´è®©agentå¯åŠ¨
            Thread.sleep(2000)
            
            println """
            ğŸ¯ Cursor Agentå·²å¯åŠ¨ï¼è¯·åœ¨ç•Œé¢ä¸­ç²˜è´´å¹¶æ‰§è¡Œæç¤ºè¯ã€‚
            
            ğŸ’¡ å°è´´å£«:
            â€¢ å¦‚æœç•Œé¢æ²¡æœ‰è‡ªåŠ¨å¼¹å‡ºï¼Œè¯·æ£€æŸ¥ä»»åŠ¡æ æˆ–æµè§ˆå™¨
            â€¢ æ‰§è¡Œå®Œæˆåå¯ä»¥ç»§ç»­åœ¨Agentä¸­è¿›è¡Œå¯¹è¯å’Œè°ƒæ•´
            â€¢ ç”Ÿæˆçš„æ–‡ä»¶ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æŒ‡å®šä½ç½®
            """
            
        } catch (Exception e) {
            println """
            âŒ Cursor Agentå¯åŠ¨å¤±è´¥: ${e.message}
            
            ğŸ’¡ å›é€€æ–¹æ¡ˆ: ä½¿ç”¨ gradle generateSqlAuto è¿›è¡ŒåŠè‡ªåŠ¨åŒ–æ“ä½œ
            """
        }
    }
}

// 2. åˆ›å»ºæ–°ä¸šåŠ¡åŸŸ
task createDomain {
    group FLINK_SQL_TASK_GROUP
    description 'ä¸ºæ–°ä¸šåŠ¡åŸŸåˆ›å»ºæ ‡å‡†åŒ–ç›®å½•ç»“æ„å’Œrequest.mdæ¨¡æ¿'
    
    doLast {
        def domainName = project.findProperty('domain') ?: 'new-domain'
        def domainDir = "${ultraSimpleSqlConfig.workspaceDir}/${domainName}"
        
        println "ğŸ—ï¸ åˆ›å»ºä¸šåŠ¡åŸŸ: ${domainName}"
        
        // åˆ›å»ºæ ‡å‡†ç›®å½•ç»“æ„
        [
            "${domainDir}/${ultraSimpleSqlConfig.outputSqlDir}",
            "${domainDir}/${ultraSimpleSqlConfig.outputTestDir}",
            "${domainDir}/${ultraSimpleSqlConfig.outputDocsDir}"
        ].each { dir ->
            mkdir dir
        }
        
        // åˆ›å»ºrequest.mdæ¨¡æ¿æ–‡ä»¶
        def requestFile = file("${domainDir}/request.md")
        if (!requestFile.exists()) {
            def templateContent = """# ${domainName} æç®€ç‰ˆFlink SQLéœ€æ±‚

## ğŸ“Š ERå›¾å®šä¹‰

```plantuml
@startuml
!theme plain
skinparam linetype ortho

' æºè¡¨å®šä¹‰ (Kafka)
entity "BusinessEvent" as be <<source>> {
  * domain : string <<ä¸šåŠ¡åŸŸ>>
  * type : string <<äº‹ä»¶ç±»å‹>>
  * payload : string <<ä¸šåŠ¡è½½è·JSON>>
  * event_time : timestamp <<äº‹ä»¶æ—¶é—´>>
  --
  table_type: source
  domain: ${domainName}
  topic: ${domainName}-events
}

' ç»´è¡¨å®šä¹‰ (MySQL + TTL) - æ ¹æ®å®é™…éœ€è¦æ·»åŠ 
entity "dim_example" as dim <<dimension>> {
  * id : string <<ä¸»é”®>> <<PK>>
  * name : string <<åç§°>>
  --
  table_type: dimension
  connector: mysql + ttl(30min)
}

' å…³è”å…³ç³»
be ||--o{ dim : "payload.example_id = id"

note right of be : "Kafkaæºè¡¨\\nè‡ªåŠ¨é…ç½®topic"
note right of dim : "MySQLç»´è¡¨\\nè‡ªåŠ¨é…ç½®TTLç¼“å­˜"
note bottom : "ç»“æœè¡¨é€šè¿‡å­—æ®µæ˜ å°„é…ç½®å®šä¹‰"

@enduml
```

## ğŸ”„ å­—æ®µæ˜ å°„å®šä¹‰

```yaml
# ç»“æœè¡¨é…ç½®
result_table:
  table_name: "dwd_${domainName}_wide"
  table_type: "result"
  connector: "odps"
  primary_key: ["id"]

# å­—æ®µæ˜ å°„é…ç½®
field_mapping:
  # åŸºç¡€å­—æ®µæ˜ å°„
  id: "payload.id"
  user_id: "payload.userId"
  
  # ç»´è¡¨å­—æ®µæ˜ å°„
  example_name: "dim_example.name"
  
  # è®¡ç®—å­—æ®µ
  status_desc: "CASE payload.status WHEN 1 THEN 'æœ‰æ•ˆ' WHEN 0 THEN 'æ— æ•ˆ' ELSE 'æœªçŸ¥' END"
  
  # æ—¶é—´å­—æ®µè½¬æ¢
  create_time: "TO_TIMESTAMP_LTZ(payload.createTime, 0)"
  
  # æ™ºèƒ½æŒ‡æ ‡å­—æ®µ (AIè‡ªåŠ¨ç”ŸæˆSQL)
  user_activity_score: "æ ¹æ®ç”¨æˆ·æ´»åŠ¨é¢‘ç‡å’Œäº¤äº’è´¨é‡è®¡ç®—ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ•°"
  business_impact_level: "åŸºäºä¸šåŠ¡æŒ‡æ ‡å’Œç”¨æˆ·è¡Œä¸ºåˆ†æä¸šåŠ¡å½±å“ç­‰çº§"
```
"""
            requestFile.text = templateContent
        }
        
        println """
        âœ… ä¸šåŠ¡åŸŸåˆ›å»ºå®Œæˆï¼
        
        ğŸ“ ç›®å½•ç»“æ„:
        ${domainDir}/
        â”œâ”€â”€ sql/                # SQLæ–‡ä»¶è¾“å‡ºç›®å½•
        â”œâ”€â”€ test/               # æµ‹è¯•æ•°æ®è¾“å‡ºç›®å½•
        â”œâ”€â”€ docs/               # æ–‡æ¡£è¾“å‡ºç›®å½•
        â””â”€â”€ request.md          # æç®€ç‰ˆéœ€æ±‚æ–‡ä»¶
        
        ğŸ“ ä¸‹ä¸€æ­¥:
        1. ç¼–è¾‘ ${requestFile.absolutePath}
        2. å®Œå–„PlantUML ERå›¾å’Œå­—æ®µæ˜ å°„
        3. è¿è¡Œ gradle generateSql -Pfile=${domainDir}/request.md
        """
    }
}

// 3. åˆ—å‡ºå¯ç”¨çš„requestæ–‡ä»¶
task listRequests {
    group FLINK_SQL_TASK_GROUP
    description 'åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„request.mdæ–‡ä»¶'
    
    doLast {
        def requestFiles = fileTree(ultraSimpleSqlConfig.workspaceDir) {
            include '**/request.md'
        }
        
        println """
        ğŸ“‹ å¯ç”¨çš„requestæ–‡ä»¶:
        ================================
        """
        
        if (requestFiles.isEmpty()) {
            println "âŒ æœªæ‰¾åˆ°ä»»ä½•request.mdæ–‡ä»¶"
            println """
            
            ğŸ’¡ åˆ›å»ºæ–°çš„ä¸šåŠ¡åŸŸ:
            gradle createDomain -Pdomain=your-domain-name
            """
        } else {
            requestFiles.each { file ->
                def relativePath = rootProject.relativePath(file)
                def domainName = file.parentFile.name
                println "ğŸ“ ${domainName}: ${relativePath}"
            }
            
            println """
            
            ğŸ’¡ ä½¿ç”¨æ–¹æ³•:
            gradle generateSql -Pfile=job/domain-name/request.md
            """
        }
    }
}

// 3.1. æµ‹è¯•ä»»åŠ¡: è°ƒè¯•AppleScriptè‡ªåŠ¨åŒ–
task testCursorAutomation {
    group FLINK_SQL_TASK_GROUP
    description 'æµ‹è¯•Cursor CLI + AppleScriptè‡ªåŠ¨åŒ–åŠŸèƒ½'
    
    doLast {
        def testPrompt = "æµ‹è¯•æç¤ºè¯ï¼šè¯·ç”Ÿæˆä¸€ä¸ªç®€å•çš„SQLæŸ¥è¯¢"
        
        println "ğŸ§ª æµ‹è¯•Cursorè‡ªåŠ¨åŒ–åŠŸèƒ½..."
        
        if (System.getProperty("os.name").toLowerCase().contains("mac")) {
            try {
                def cursorCliPath = ultraSimpleSqlConfig.cursorCliPath
                def cursorCli = file(cursorCliPath)
                
                if (cursorCli.exists()) {
                    println "1ï¸âƒ£ ä½¿ç”¨Cursor CLIæ‰“å¼€é¡¹ç›®..."
                    def cursorProcess = new ProcessBuilder([cursorCliPath, "."]).start()
                    cursorProcess.waitFor()
                    
                    println "2ï¸âƒ£ å¤åˆ¶æµ‹è¯•æç¤ºè¯åˆ°å‰ªè´´æ¿..."
                    def clipboardProcess = new ProcessBuilder(["pbcopy"]).start()
                    clipboardProcess.outputStream.write(testPrompt.bytes)
                    clipboardProcess.outputStream.close()
                    clipboardProcess.waitFor()
                    
                    println "3ï¸âƒ£ ç­‰å¾…Cursorå¯åŠ¨..."
                    Thread.sleep(3000)
                    
                    println "4ï¸âƒ£ æ‰§è¡ŒAppleScriptè‡ªåŠ¨åŒ–..."
                    def appleScript = """
                    tell application "Cursor"
                        activate
                    end tell
                    
                    delay 2
                    
                    tell application "System Events"
                        keystroke "k" using {command down, shift down}
                        delay 3
                        keystroke "v" using {command down}
                        delay 1
                        key code 36
                    end tell
                    """.stripIndent()
                    
                    def tempScript = File.createTempFile("test_cursor", ".scpt")
                    tempScript.text = appleScript
                    
                    def scriptProcess = new ProcessBuilder(["osascript", tempScript.absolutePath])
                        .redirectErrorStream(true)
                        .start()
                    
                    def output = scriptProcess.inputStream.text
                    def exitCode = scriptProcess.waitFor()
                    
                    tempScript.delete()
                    
                    if (exitCode == 0) {
                        println "âœ… AppleScriptè‡ªåŠ¨åŒ–æµ‹è¯•æˆåŠŸï¼"
                    } else {
                        println "âŒ AppleScriptæ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : ${exitCode}"
                        println "é”™è¯¯è¾“å‡º: ${output}"
                    }
                } else {
                    println "âŒ Cursor CLIä¸å¯ç”¨"
                }
            } catch (Exception e) {
                println "âŒ æµ‹è¯•å¤±è´¥: ${e.message}"
                e.printStackTrace()
            }
        } else {
            println "âš ï¸ æ­¤åŠŸèƒ½ä»…æ”¯æŒmacOS"
        }
    }
}

// 4. Cursor CLIæ£€æŸ¥å’Œè®¾ç½®ä»»åŠ¡
task setupCursorCli {
    group FLINK_SQL_TASK_GROUP
    description 'æ£€æŸ¥å’Œè®¾ç½®Cursor CLIè·¯å¾„'
    
    doLast {
        def cursorCliPath = ultraSimpleSqlConfig.cursorCliPath
        def cursorCli = file(cursorCliPath)
        
        println """
        ğŸ” Cursor CLIç¯å¢ƒæ£€æŸ¥
        ===================================
        """
        
        println "ğŸ“ é…ç½®è·¯å¾„: ${cursorCliPath}"
        println "   å­˜åœ¨: ${cursorCli.exists() ? 'âœ…' : 'âŒ'}"
        
        if (cursorCli.exists()) {
            try {
                def process = new ProcessBuilder([cursorCliPath, "--version"])
                    .redirectOutput(ProcessBuilder.Redirect.PIPE)
                    .start()
                def version = process.inputStream.text.trim()
                process.waitFor()
                
                println "   ç‰ˆæœ¬: ${version}"
                println """
                âœ… Cursor CLI å¯ç”¨ï¼
                
                ğŸ’¡ ä½¿ç”¨æ–¹æ³•:
                gradle generateSqlAuto -Pfile=job/domain/request.md
                """
            } catch (Exception e) {
                println "   é”™è¯¯: ${e.message}"
            }
        } else {
            println """
            âŒ Cursor CLI ä¸å¯ç”¨
            
            ğŸ’¡ è§£å†³æ–¹æ³•:
            1. ç¡®ä¿å·²å®‰è£… Cursor.app
            2. æ£€æŸ¥å®‰è£…è·¯å¾„æ˜¯å¦ä¸º: ${cursorCliPath}
            3. å¦‚æœè·¯å¾„ä¸åŒï¼Œè¯·ä¿®æ”¹ build.gradle ä¸­çš„ cursorCliPath é…ç½®
            
            ğŸ”§ å…¶ä»–å¯èƒ½çš„è·¯å¾„:
            - /usr/local/bin/cursor
            - /opt/homebrew/bin/cursor
            - ~/.cursor/cursor
            """
        }
        
        // å°è¯•æŸ¥æ‰¾å…¶ä»–å¯èƒ½çš„Cursor CLIè·¯å¾„
        def alternativePaths = [
            "/usr/local/bin/cursor",
            "/opt/homebrew/bin/cursor",
            "~/.cursor/cursor",
            "/Applications/Cursor.app/Contents/MacOS/Cursor"
        ]
        
        def foundAlternatives = []
        alternativePaths.each { path ->
            def expandedPath = path.startsWith("~") ? 
                path.replace("~", System.getProperty("user.home")) : path
            if (file(expandedPath).exists()) {
                foundAlternatives.add(expandedPath)
            }
        }
        
        if (foundAlternatives.size() > 0) {
            println """
            
            ğŸ” å‘ç°å…¶ä»–Cursor CLIè·¯å¾„:
            ${foundAlternatives.collect { "   - ${it}" }.join('\n')}
            """
        }
        
        println "==================================="
    }
}

// 5. ç¯å¢ƒæ£€æŸ¥ä»»åŠ¡
task checkEnvironment {
    group FLINK_SQL_TASK_GROUP
    description 'æ£€æŸ¥æç®€ç‰ˆSQLç”Ÿæˆå™¨ç¯å¢ƒ'
    
    doLast {
        println """
        ğŸ” æç®€ç‰ˆFlink SQLç”Ÿæˆå™¨ç¯å¢ƒæ£€æŸ¥
        ===================================================
        """
        
        // æ£€æŸ¥å·¥ä½œç©ºé—´
        def workspaceDir = file(ultraSimpleSqlConfig.workspaceDir)
        println "ğŸ“ å·¥ä½œç©ºé—´: ${workspaceDir.absolutePath}"
        println "   å­˜åœ¨: ${workspaceDir.exists() ? 'âœ…' : 'âŒ'}"
        
        // æ£€æŸ¥è§„åˆ™æ–‡ä»¶
        def rulesFile = file(ultraSimpleSqlConfig.rulesFile)
        println "ğŸ“‹ è§„åˆ™æ–‡ä»¶: ${rulesFile.absolutePath}"
        println "   å­˜åœ¨: ${rulesFile.exists() ? 'âœ…' : 'âŒ'}"
        
        // æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶
        def templateFile = file(ultraSimpleSqlConfig.templateFile)
        println "ğŸ“„ æ¨¡æ¿æ–‡ä»¶: ${templateFile.absolutePath}"
        println "   å­˜åœ¨: ${templateFile.exists() ? 'âœ…' : 'âŒ'}"
        
        // æ£€æŸ¥requestæ–‡ä»¶
        if (workspaceDir.exists()) {
            def requestFiles = fileTree(workspaceDir) {
                include '**/request.md'
            }
            println "ğŸ“ Requestæ–‡ä»¶: ${requestFiles.files.size()}ä¸ª"
            requestFiles.each { file ->
                def relativePath = rootProject.relativePath(file)
                println "   - ${relativePath}"
            }
        }
        
        println """
        ===================================================
        
        ğŸ’¡ ä½¿ç”¨æŒ‡å—:
        1. gradle createDomain -Pdomain=domain-name  # åˆ›å»ºæ–°ä¸šåŠ¡åŸŸ
        2. gradle listRequests                       # åˆ—å‡ºæ‰€æœ‰requestæ–‡ä»¶
        3. gradle generateSql -Pfile=path/to/request.md  # ç”ŸæˆSQL
        4. gradle help                               # æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
        
        ğŸ¤– AIæ‰§è¡Œæ–¹å¼:
        - å½“å‰éœ€è¦åœ¨Cursor IDEä¸­æ‰‹åŠ¨æ‰§è¡ŒAIè§„åˆ™
        - è§„åˆ™æ–‡ä»¶: ${ultraSimpleSqlConfig.rulesFile}
        """
    }
}

// 5. å¸®åŠ©ä»»åŠ¡
task sqlHelp {
    group FLINK_SQL_TASK_GROUP
    description 'æ˜¾ç¤ºæç®€ç‰ˆFlink SQLç”Ÿæˆå™¨ä½¿ç”¨å¸®åŠ©'
    
    doLast {
        println """
        
        ğŸš€ æç®€ç‰ˆFlink SQLç”Ÿæˆå™¨ä½¿ç”¨æŒ‡å—
        ===============================================
        
        ğŸ“‹ ä¸»è¦ä»»åŠ¡:
        â”œâ”€â”€ generateSql      - ç”ŸæˆFlink SQLå’Œæµ‹è¯•æ•°æ® (å¤åˆ¶åˆ°å‰ªè´´æ¿)
        â”œâ”€â”€ generateSqlAuto  - è‡ªåŠ¨åœ¨Cursorä¸­æ‰§è¡Œç”Ÿæˆ (ä½¿ç”¨Cursor CLI)
        â”œâ”€â”€ createDomain     - åˆ›å»ºæ–°ä¸šåŠ¡åŸŸ
        â”œâ”€â”€ listRequests     - åˆ—å‡ºæ‰€æœ‰requestæ–‡ä»¶
        â”œâ”€â”€ setupCursorCli   - æ£€æŸ¥å’Œè®¾ç½®Cursor CLIç¯å¢ƒ
        â”œâ”€â”€ checkEnvironment - æ£€æŸ¥ç¯å¢ƒé…ç½®
        â””â”€â”€ sqlHelp          - æ˜¾ç¤ºæœ¬å¸®åŠ©ä¿¡æ¯
        
        ğŸ¯ ä½¿ç”¨æµç¨‹:
        
        1ï¸âƒ£ åˆ›å»ºæ–°ä¸šåŠ¡åŸŸ:
           gradle createDomain -Pdomain=your-domain-name
        
        2ï¸âƒ£ ç¼–è¾‘request.mdæ–‡ä»¶:
           - è®¾è®¡PlantUML ERå›¾ (ä»…æºè¡¨/ç»´è¡¨)
           - é…ç½®ç»“æœè¡¨å’Œå­—æ®µæ˜ å°„
           - æ·»åŠ æ™ºèƒ½æŒ‡æ ‡æè¿°
        
        3ï¸âƒ£ ç”ŸæˆFlink SQL:
           gradle generateSql -Pfile=job/your-domain/request.md      # å¤åˆ¶åˆ°å‰ªè´´æ¿
           gradle generateSqlAuto -Pfile=job/your-domain/request.md   # åŠè‡ªåŠ¨åŒ– (æ¨è)
           gradle generateSqlAgent -Pfile=job/your-domain/request.md  # å®Œå…¨è‡ªåŠ¨åŒ– (Beta)
        
        4ï¸âƒ£ AIæ‰§è¡Œé€‰é¡¹:
           - generateSql: æç¤ºè¯å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œæ‰‹åŠ¨åœ¨Cursorä¸­æ‰§è¡Œ
           - generateSqlAuto: æ™ºèƒ½é›†æˆï¼Œè‡ªåŠ¨æ‰“å¼€Cursor+å¤åˆ¶æç¤ºè¯ (ä»…éœ€2æ­¥)
           - generateSqlAgent: å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ (Betaï¼Œéœ€Cursor Agent CLI)
           
        ğŸ”§ ç¯å¢ƒè®¾ç½®:
           gradle setupCursorCli  # æ£€æŸ¥Cursor CLIæ˜¯å¦å¯ç”¨
        
        âš¡ å¿«é€Ÿç¤ºä¾‹:
        gradle createDomain -Pdomain=user-analytics
        gradle generateSql -Pfile=job/user-analytics/request.md
        
        ğŸ“š æ›´å¤šä¿¡æ¯:
        - è§„åˆ™æ–‡ä»¶: ${ultraSimpleSqlConfig.rulesFile}
        - æ¨¡æ¿æ–‡ä»¶: ${ultraSimpleSqlConfig.templateFile}
        - è¾“å‡ºç›®å½•: è‡ªåŠ¨åœ¨å¯¹åº”ä¸šåŠ¡åŸŸä¸‹åˆ›å»º
        
        ===============================================
        """
    }
}

publishing {
    publications {
        maven(MavenPublication) {
            from components.java
        }
    }
}