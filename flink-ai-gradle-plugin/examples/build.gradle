// ä½¿ç”¨Flink AIå·¥ä½œæµæ’ä»¶çš„ç¤ºä¾‹é¡¹ç›®é…ç½®
plugins {
    id 'java'
    id 'com.flink.ai.workflow' version '1.0.0'
}

// åŸºç¡€é¡¹ç›®é…ç½®
group = 'com.example.flink'
version = '1.0.0'

repositories {
    mavenCentral()
}

dependencies {
    // Flink dependencies
    implementation 'org.apache.flink:flink-streaming-java:1.18.0'
    implementation 'org.apache.flink:flink-table-api-java-bridge:1.18.0'
    
    // å…¶ä»–ä¾èµ–...
}

// =============================================================================
// Flink AIå·¥ä½œæµæ’ä»¶é…ç½®
// =============================================================================
flinkAiWorkflow {
    // åŸºç¡€é…ç½®
    workspaceDir = 'job'                    // å·¥ä½œç©ºé—´ç›®å½•
    aiProvider = 'cursor'                   // AIæä¾›è€…: cursor, openai, azure
    rulesDir = '.cursor/rules'              // AIè§„åˆ™æ–‡ä»¶ç›®å½•
    configDir = 'job/ai-config'             // é…ç½®æ–‡ä»¶ç›®å½•
    enableWatch = false                     // æ˜¯å¦å¯ç”¨æ–‡ä»¶ç›‘æ§
    enableDeploymentGeneration = true       // æ˜¯å¦è‡ªåŠ¨ç”Ÿæˆéƒ¨ç½²é…ç½®
    
    // AIå¼•æ“é…ç½®
    model = 'gpt-4'                         // AIæ¨¡å‹
    workflowTimeoutMinutes = 10             // å·¥ä½œæµè¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    maxRetries = 3                          // æœ€å¤§é‡è¯•æ¬¡æ•°
    
    // è´¨é‡æ§åˆ¶é…ç½®
    qualityGateMode = 'strict'              // è´¨é‡é—¨æ§æ¨¡å¼: strict, permissive, advisory
    minQualityScore = 85                    // æœ€ä½è´¨é‡è¯„åˆ†
    allowWarnings = true                    // æ˜¯å¦å…è®¸Warningçº§åˆ«é—®é¢˜
    criticalIssuesThreshold = 0             // Criticalé—®é¢˜å®¹å¿æ•°é‡
    
    // ä¸šåŠ¡åŸŸé…ç½®
    domains = ['wrongbook', 'user-stats']   // åŒ…å«çš„ä¸šåŠ¡åŸŸ
    excludedDomains = []                    // æ’é™¤çš„ä¸šåŠ¡åŸŸ
    
    // è¾“å‡ºé…ç½®
    outputDir = 'build/ai-workflow'         // è¾“å‡ºç›®å½•
    generateDetailedReports = true          // æ˜¯å¦ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
    reportFormat = 'markdown'               // æŠ¥å‘Šæ ¼å¼: markdown, html, json
    enableBackup = true                     // æ˜¯å¦å¤‡ä»½ç”Ÿæˆæ–‡ä»¶
    
    // ERçŸ¥è¯†åº“é…ç½®
    knowledgeBaseDir = 'job/knowledge-base' // çŸ¥è¯†åº“ç›®å½•
    conflictDetectionSensitivity = 'medium' // å†²çªæ£€æµ‹æ•æ„Ÿåº¦: low, medium, high
    autoResolveCompatibleConflicts = true   // è‡ªåŠ¨è§£å†³å…¼å®¹æ€§å†²çª
    erDiagramFormat = 'mermaid'             // ERå›¾æ ¼å¼: mermaid, plantuml, both
    
    // é«˜çº§é…ç½®
    enableParallelExecution = false         // å¹¶è¡Œæ‰§è¡Œï¼ˆå®éªŒæ€§ï¼‰
    maxParallelTasks = 3                    // æœ€å¤§å¹¶è¡Œä»»åŠ¡æ•°
    enableCache = true                      // å¯ç”¨ç¼“å­˜
    cacheExpiryHours = 24                   // ç¼“å­˜æœ‰æ•ˆæœŸ
    debugMode = false                       // è°ƒè¯•æ¨¡å¼
    logLevel = 'INFO'                       // æ—¥å¿—çº§åˆ«
    
    // AIé…ç½®ï¼ˆå¯é€‰ï¼Œæ ¹æ®providerä¸åŒï¼‰
    aiConfig = [
        'api_key': System.getenv('OPENAI_API_KEY'),
        'base_url': 'https://api.openai.com/v1',
        'timeout': '60'
    ]
}

// =============================================================================
// ä»»åŠ¡é…ç½®å’Œä¾èµ–å…³ç³»
// =============================================================================

// 1. å®Œæ•´çš„AIå·¥ä½œæµä»»åŠ¡
// gradle runAiWorkflow
// æ‰§è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯å·¥ä½œæµï¼ˆSQLç”Ÿæˆ â†’ éªŒè¯ â†’ ERçŸ¥è¯†åº“æ›´æ–°ï¼‰

// 2. å•ç‹¬çš„é˜¶æ®µä»»åŠ¡
// gradle generateFlinkSql          - ä»…æ‰§è¡ŒSQLç”Ÿæˆ
// gradle validateFlinkSql          - ä»…æ‰§è¡Œæ•°æ®éªŒè¯
// gradle updateErKnowledgeBase     - ä»…æ‰§è¡ŒERçŸ¥è¯†åº“æ›´æ–°

// 3. è¾…åŠ©ä»»åŠ¡
// gradle initAiWorkflow            - åˆå§‹åŒ–AIå·¥ä½œæµç¯å¢ƒ
// gradle createFlinkDomain         - åˆ›å»ºæ–°ä¸šåŠ¡åŸŸè„šæ‰‹æ¶
// gradle generateQualityReport     - ç”Ÿæˆé¡¹ç›®è´¨é‡æŠ¥å‘Š
// gradle generateDeploymentConfig  - ç”Ÿæˆéƒ¨ç½²é…ç½®

// 4. ç›‘æ§å’Œç»´æŠ¤ä»»åŠ¡
// gradle watchRequestFiles         - ç›‘æ§æ–‡ä»¶å˜æ›´ï¼Œè‡ªåŠ¨è§¦å‘å·¥ä½œæµ
// gradle checkKnowledgeBaseConsistency - æ£€æŸ¥çŸ¥è¯†åº“ä¸€è‡´æ€§

// è‡ªå®šä¹‰ä»»åŠ¡ç¤ºä¾‹ï¼šé›†æˆåˆ°æ„å»ºæµç¨‹ä¸­
build.dependsOn 'generateFlinkSql'

// éƒ¨ç½²å‰éªŒè¯
task deploymentValidation {
    dependsOn 'validateFlinkSql'
    
    doLast {
        println "âœ… éƒ¨ç½²å‰éªŒè¯å®Œæˆ"
    }
}

// ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é…ç½®
task generateProdConfig {
    dependsOn 'generateDeploymentConfig'
    
    doLast {
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç”Ÿäº§ç¯å¢ƒç‰¹å®šçš„é…ç½®è°ƒæ•´
        println "ğŸš€ ç”Ÿäº§ç¯å¢ƒé…ç½®å·²ç”Ÿæˆ"
    }
}

// =============================================================================
// ç¯å¢ƒç‰¹å®šé…ç½®
// =============================================================================

// å¼€å‘ç¯å¢ƒé…ç½®
if (project.hasProperty('dev')) {
    flinkAiWorkflow {
        qualityGateMode = 'permissive'
        debugMode = true
        logLevel = 'DEBUG'
        workflowTimeoutMinutes = 20  // å¼€å‘ç¯å¢ƒå…è®¸æ›´é•¿çš„è¶…æ—¶æ—¶é—´
    }
}

// æµ‹è¯•ç¯å¢ƒé…ç½®
if (project.hasProperty('test')) {
    flinkAiWorkflow {
        qualityGateMode = 'strict'
        generateDetailedReports = true
        enableBackup = false  // æµ‹è¯•ç¯å¢ƒä¸éœ€è¦å¤‡ä»½
    }
}

// ç”Ÿäº§ç¯å¢ƒé…ç½®
if (project.hasProperty('prod')) {
    flinkAiWorkflow {
        qualityGateMode = 'strict'
        minQualityScore = 95  // ç”Ÿäº§ç¯å¢ƒè¦æ±‚æ›´é«˜çš„è´¨é‡æ ‡å‡†
        criticalIssuesThreshold = 0
        allowWarnings = false  // ç”Ÿäº§ç¯å¢ƒä¸å…è®¸è­¦å‘Š
        enableBackup = true
        enableCache = false  // ç”Ÿäº§ç¯å¢ƒæ¯æ¬¡é‡æ–°ç”Ÿæˆ
    }
}

// =============================================================================
// è‡ªå®šä¹‰ä»»åŠ¡ç¤ºä¾‹
// =============================================================================

// æ‰¹é‡å¤„ç†å¤šä¸ªä¸šåŠ¡åŸŸ
task processAllDomains {
    dependsOn 'runAiWorkflow'
    
    doLast {
        def outputDir = file(flinkAiWorkflow.outputDir.get())
        if (outputDir.exists()) {
            outputDir.listFiles().each { domainDir ->
                if (domainDir.isDirectory()) {
                    println "ğŸ“Š å¤„ç†å®Œæˆä¸šåŠ¡åŸŸ: ${domainDir.name}"
                }
            }
        }
    }
}

// ç”Ÿæˆé¡¹ç›®æŠ¥å‘Š
task generateProjectReport {
    dependsOn 'generateQualityReport'
    
    doLast {
        println """
        ğŸ¯ é¡¹ç›®å¤„ç†å®Œæˆï¼
        
        å·¥ä½œç©ºé—´: ${flinkAiWorkflow.workspaceDir.get()}
        è¾“å‡ºç›®å½•: ${flinkAiWorkflow.outputDir.get()}
        è´¨é‡æ ‡å‡†: ${flinkAiWorkflow.minQualityScore.get()}åˆ†
        
        æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: ${flinkAiWorkflow.outputDir.get()}/overall-report.md
        """
    }
}

// æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶
task cleanAiOutput(type: Delete) {
    delete flinkAiWorkflow.outputDir.get()
}

clean.dependsOn cleanAiOutput
